<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XzeCure ICU Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .protocol-item {
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .protocol-item:hover {
            background-color: #f3f4f6;
        }
        .protocol-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .protocol-content.active {
            max-height: 2000px; /* Large enough to accommodate content */
            transition: max-height 0.4s ease-in;
        }
        .protocol-category {
            cursor: pointer;
            @apply p-4 mb-3 rounded-lg font-extrabold text-xl bg-blue-100 text-blue-800 hover:bg-blue-200 transition duration-150;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 flex flex-col min-h-screen">

    <!-- Header and Emergency Button (Always Visible) -->
    <header class="mb-6 bg-white p-4 rounded-xl card-shadow flex flex-col md:flex-row justify-between items-center">
        <div>
            <h1 class="text-3xl font-extrabold text-blue-900">XzeCure ABG Tool</h1>
            <p class="text-sm text-gray-600">Arterial Blood Gas Analysis & Metabolic Status Interpreter</p>
        </div>
        <a href="https://api.whatsapp.com/send?phone=918200095781&text=My%20Patient%20needs%20urgent%20ICU%20care.%20Where%20can%20we%20refer%3F" 
           target="_blank"
           class="mt-4 md:mt-0 px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150 shadow-lg text-center whitespace-nowrap">
            üö® Emergency (Refer to ICU)
        </a>
    </header>

    <!-- MAIN APP CONTAINER -->
    <div class="flex-grow">
        
        <!-- ABG CALCULATOR VIEW -->
        <div id="abg-view" class="bg-white p-4 sm:p-6 rounded-xl card-shadow mb-8">
            <h2 class="text-xl font-semibold mb-4 text-blue-700 border-b pb-2">ABG Interpretation and Metabolic Status</h2>
            
            <!-- ABG Inputs -->
            <div id="abg-inputs" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 mb-6">
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-700">pH <span class="text-red-500">*</span></label><input type="number" id="input_pH" value="7.18" step="0.01" class="w-full p-2 border border-gray-300 rounded-md text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-700">PaCO‚ÇÇ (mmHg) <span class="text-red-500">*</span></label><input type="number" id="input_paco2" value="28" class="w-full p-2 border border-gray-300 rounded-md text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-700">HCO‚ÇÉ‚Åª (mmol/L) <span class="text-red-500">*</span></label><input type="number" id="input_hco3" value="8" class="w-full p-2 border border-gray-300 rounded-md text-sm"></div>
                
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-700">Na (mmol/L)</label><input type="number" id="input_na" value="135" class="w-full p-2 border border-gray-300 rounded-md text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-700">Cl (mmol/L)</label><input type="number" id="input_cl" value="95" class="w-full p-2 border border-gray-300 rounded-md text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-700">K (mmol/L)</label><input type="number" id="input_k" value="4.5" class="w-full p-2 border border-gray-300 rounded-md text-sm"></div>
                
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-700">PaO‚ÇÇ (mmHg)</label><input type="number" id="input_pao2" value="90" class="w-full p-2 border border-gray-300 rounded-md text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-700">FiO‚ÇÇ (0.21 - 1.0)</label><input type="number" id="input_fio2" value="0.21" step="0.01" class="w-full p-2 border border-gray-300 rounded-md text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-700">Age (Years)</label><input type="number" id="input_age" value="30" class="w-full p-2 border border-gray-300 rounded-md text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-700">Albumin (g/dL)</label><input type="number" id="input_albumin" value="4.0" step="0.1" class="w-full p-2 border border-gray-300 rounded-md text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-700">Lactate (mmol/L)</label><input type="number" id="input_lactate" value="3.2" step="0.1" class="w-full p-2 border border-gray-300 rounded-md text-sm"></div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 mb-4">
                <button onclick="interpretABG()" class="w-full sm:w-2/3 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                    Interpret ABG & Metabolic Status
                </button>
                <button onclick="showProtocolsPage()" class="w-full sm:w-1/3 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-150 shadow-md relative">
                    View Protocols 
                    <span class="absolute top-0 right-0 -mt-2 -mr-2 px-2 py-0.5 text-xs font-bold leading-none text-white bg-red-600 rounded-full">NEW</span>
                </button>
            </div>

            <!-- Loading Indicator & Error Message -->
            <div id="abg-loading" class="hidden text-center text-blue-500 font-medium my-4">Analyzing complex acid-base interactions...</div>
            <div id="abg-error" class="text-red-600 text-sm hidden p-3 bg-red-50 border border-red-200 rounded-md mb-4"></div>
            <div id="abg-message" class="text-green-700 text-sm hidden p-3 bg-green-50 border border-green-200 rounded-md mb-4"></div>


            <!-- Results Output -->
            <div id="abg-output" class="mt-6 border-t pt-4 hidden">
                <div id="result-summary"></div>
                <button id="toggle-log" onclick="toggleCalculationLog()" class="mt-3 text-sm font-medium text-blue-600 hover:text-blue-800 hidden">Show Calculation Log</button>
                <div id="calculation-log" class="mt-3 p-3 bg-gray-100 rounded-lg text-xs hidden whitespace-pre-wrap overflow-x-auto"></div>
            </div>
        </div>

        <!-- PROTOCOLS PAGE VIEW (Initially Hidden) -->
        <div id="protocol-view" class="bg-white p-4 sm:p-6 rounded-xl card-shadow mb-8 hidden">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-2xl font-bold text-green-700">Clinical Protocols</h3>
                <button onclick="showCalculatorPage()" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition text-sm">
                    ‚Üê Back to Calculator
                </button>
            </div>
            
            <!-- Protocol Categories (Clickable to reveal sub-protocols) -->
            <div id="protocol-category-1" onclick="toggleProtocolCategory('1')" class="protocol-category">
                1) RESUSCITATION & CODE BLUE <span class="float-right text-lg arrow-1">‚Üí</span>
            </div>
            <div id="protocol-items-1" class="protocol-category-items border p-4 rounded-lg bg-gray-50 mb-4 hidden space-y-2">
                <!-- Dropdown items will be appended here by JS when category is clicked -->
                
                <!-- Protocol Dropdown A -->
                <div id="protocol-1A" class="border border-gray-200 rounded-lg">
                    <div onclick="toggleProtocol('protocol-1A-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-blue-700 text-sm">
                        A (ACLS ALGORITHM)
                        <span class="text-lg">‚ñº</span>
                    </div>
                    <div id="protocol-1A-content" class="protocol-content p-4 bg-white text-xs whitespace-pre-wrap">
                        **A. ACLS ‚Äî Adult Cardiac Arrest Algorithm**

                        **Indication:**
                          - Unresponsive patient, absent or abnormal breathing (agonal), and no palpable pulse.
                        **Goal:**
                          - Achieve return of spontaneous circulation (ROSC) with high-quality CPR, timely defibrillation
                            (if indicated), and management of reversible causes.
                        **Preparation / Equipment:**
                          - CPR team: team leader, chest compressor(s), airway operator, IV/IO access operator, scribe.
                          - Defibrillator/AED, airway kit (BVM, laryngoscope, ETT, supraglottic devices, bougie),
                            suction, resuscitation drugs (epinephrine, amiodarone, lidocaine), capnography, monitors.
                        **Step-by-step Checklist:**
                          1. Ensure scene safety and assess responsiveness. Call for help / activate code.
                          2. Start high-quality CPR immediately (compression rate $100-120$/min; depth $5-6$ cm;
                             allow full chest recoil). Rotate compressors every $2$ minutes.
                          3. Attach monitor/defibrillator as soon as available and analyze rhythm.
                          4. **If shockable rhythm (VF / pulseless VT):**
                             - Deliver immediate unsynchronized shock (biphasic device energy per manufacturer).
                             - Resume CPR immediately for $2$ minutes without interrupting compressions.
                             - After $2$ minutes, check rhythm and pulse; repeat shock if shockable.
                             - Give epinephrine $1$ mg IV/IO every $3-5$ minutes (as soon as vascular access available).
                             - Consider amiodarone $300$ mg IV bolus after the $3^{rd}$ shock (repeat $150$ mg if needed).
                          5. **If non-shockable rhythm (PEA / asystole):**
                             - Continue CPR in $2$-minute cycles.
                             - Give epinephrine $1$ mg IV/IO as soon soon as possible; repeat q$3-5$ min.
                             - Identify and treat reversible causes (Hs $\&$ Ts).
                          6. **Airway management:** secure advanced airway when feasible (ETT or supraglottic).
                             - Once advanced airway placed: continuous CPR with ventilation rate $\sim 10$ breaths/min
                               ($1$ breath every $6$ seconds) and continuous capnography monitoring.
                          7. **Reversible causes:** evaluate and treat Hs $\&$ Ts:
                             - **Hypovolemia, Hypoxia, Hydrogen ion (acidosis), Hypo/Hyperkalemia, Hypothermia.**
                             - **Tension pneumothorax, Tamponade (cardiac), Toxins, Thrombosis (pulmonary/coronary).**
                          8. **If ROSC achieved:**
                             - Implement post-cardiac arrest care: maintain oxygenation ($\text{SpO}_2$ $92-98\%$), target MAP $\ge 65$ mmHg,
                               consider targeted temperature management (TTM) if comatose, and identify $\&$ treat cause.
                        **Orders $\&$ Monitoring:**
                          - Continuous ECG, $\text{SpO}_2$, $\text{EtCO}_2$; ABG analysis; immediate CXR after stabilization;
                            labs: electrolytes, glucose, CBC, coagulation, troponin; consider urgent coronary angiography
                            if STEMI suspected.
                        **Escalation / When to Call Senior:**
                          - If prolonged arrests, refractory VF/VT after multiple shocks, or complex reversible causes ‚Äî
                            call ICU consultant, cardiology, and consider ECMO team if available.
                        **Notes:**
                          - Minimize interruptions to chest compressions; prioritize high-quality CPR and early defibrillation.
                          - Document times (compressions start, shocks, drug doses, ROSC).
                    </div>
                </div>

                <!-- Protocol Dropdown B -->
                <div id="protocol-1B" class="border border-gray-200 rounded-lg">
                    <div onclick="toggleProtocol('protocol-1B-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-blue-700 text-sm">
                        B (BLS ALGORITHM)
                        <span class="text-lg">‚ñº</span>
                    </div>
                    <div id="protocol-1B-content" class="protocol-content p-4 bg-white text-xs whitespace-pre-wrap">
                        **B. BLS (Basic Life Support) for Healthcare Providers**

                        **Indication:**
                          - Unresponsive patient with absent or abnormal breathing.
                        **Checklist:**
                          - Check responsiveness; shout for help; open airway and check breathing (no more than $10$ sec).
                          - Call for code / activate emergency response.
                          - Start high-quality CPR: single rescuer adult $30$ compressions : $2$ breaths.
                          - Attach AED / defibrillator and follow prompts; resume CPR immediately after shock.
                        **Notes:**
                          - With two rescuers and advanced airway in place, give continuous compressions with $1$ breath every $6$ sec.
                    </div>
                </div>

                <!-- Protocol Dropdown C -->
                <div id="protocol-1C" class="border border-gray-200 rounded-lg">
                    <div onclick="toggleProtocol('protocol-1C-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-blue-700 text-sm">
                        C (Post cardiac arrest)
                        <span class="text-lg">‚ñº</span>
                    </div>
                    <div id="protocol-1C-content" class="protocol-content p-4 bg-white text-xs whitespace-pre-wrap">
                        **C. Post-Cardiac Arrest Care (Immediate)**

                        **Goals:**
                          - Optimize oxygenation and perfusion; prevent secondary brain injury; treat underlying cause.
                        **Checklist:**
                          1. Maintain oxygenation: target $\text{SpO}_2$ $92-98\%$ (avoid hyperoxia).
                          2. Hemodynamic support: maintain MAP $\ge 65$ mmHg (titrate vasopressors ‚Äî norepinephrine first-line).
                          3. Obtain 12-lead ECG; if STEMI $\rightarrow$ consult cardiology for immediate reperfusion (PCI) if appropriate.
                          4. Consider targeted temperature management (TTM) for comatose survivors per local protocol.
                          5. Continue neurological monitoring and send neuroimaging as indicated.
                        **Monitoring $\&$ Orders:**
                          - Frequent neuro checks, continuous cardiac monitoring, ABG, electrolytes, lactate, urine output.
                        **Notes:**
                          - Post-arrest care is multidisciplinary; early involvement of cardiology and neurology may be critical.
                    </div>
                </div>
            </div>


            <!-- Protocol Category 2 (Clickable to reveal sub-protocols) -->
            <div id="protocol-category-2" onclick="toggleProtocolCategory('2')" class="protocol-category">
                2) AIRWAY & VENTILATION <span class="float-right text-lg arrow-2">‚Üí</span>
            </div>
            <div id="protocol-items-2" class="protocol-category-items border p-4 rounded-lg bg-gray-50 hidden space-y-2">
                
                <!-- Protocol Dropdown 2A -->
                <div id="protocol-2A" class="border border-gray-200 rounded-lg">
                    <div onclick="toggleProtocol('protocol-2A-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-blue-700 text-sm">
                        A) Rapid Sequence Intubation (RSI) Checklist (Adult)
                        <span class="text-lg">‚ñº</span>
                    </div>
                    <div id="protocol-2A-content" class="protocol-content p-4 bg-white text-xs whitespace-pre-wrap">
                        **A. Rapid Sequence Intubation (RSI) Checklist (Adult)**
                        
                        **Indication:**
                          - Need for definitive airway due to respiratory failure, loss of airway protection, GCS $\le 8$,
                            or anticipated deterioration.
                        **Goal:**
                          - Secure airway rapidly and safely while minimizing hypoxia and hemodynamic compromise.
                        **Preparation / Equipment:**
                          - RSI kit: laryngoscope (direct/video), ETTs in appropriate sizes, stylet/bougie, suction,
                            BVM with PEEP, capnography, oxygen source, backup supraglottic devices (LMA), surgical airway kit.
                          - Assign roles: airway operator, assistant, drug nurse, airway assistant, scribe.
                        **Step-by-step Checklist:**
                          1. Pre-oxygenate for $3-5$ minutes with $100\%$ O$_2$ (consider HFNC + NRB or BVM with PEEP).
                          2. Position patient (ramp position for obese; sniffing position as indicated).
                          3. Prepare and check all equipment; ensure functioning suction and capnography.
                          4. Prepare induction agent and paralytic (e.g., etomidate $0.2-0.3$ mg/kg or ketamine $1-2$ mg/kg;
                             succinylcholine $1-1.5$ mg/kg or rocuronium $1$ mg/kg ‚Äî choose per hemodynamic status and contraindications).
                          5. Pre-treatment if indicated (e.g., fentanyl to blunt sympathetic response; atropine in infants).
                          6. Perform intubation attempt (limit to maximum $2-3$ attempts by experienced operators).
                          7. If first-pass fails $\rightarrow$ consider repositioning, use bougie, video laryngoscope, or change operator.
                          8. If cannot intubate and cannot ventilate $\rightarrow$ proceed to supraglottic airway and call for emergency surgical airway.
                          9. Confirm tube placement with continuous waveform capnography, chest rise, and auscultation.
                         10. Secure tube and document insertion depth and confirmation method.
                        **Post-intubation Management:**
                          - Start mechanical ventilation with appropriate initial settings (e.g., lung-protective strategy if ARDS risk).
                          - Start sedation $\&$ analgesia; monitor BP and HR; obtain CXR to confirm position.
                        **Escalation:**
                          - If oxygenation or ventilation inadequate, call senior ICU/anaesthesia and consider bronchoscopy or surgical airway.
                    </div>
                </div>

                <!-- Protocol Dropdown 2B -->
                <div id="protocol-2B" class="border border-gray-200 rounded-lg">
                    <div onclick="toggleProtocol('protocol-2B-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-blue-700 text-sm">
                        B) Difficult Airway Algorithm
                        <span class="text-lg">‚ñº</span>
                    </div>
                    <div id="protocol-2B-content" class="protocol-content p-4 bg-white text-xs whitespace-pre-wrap">
                        **B. Difficult Airway Algorithm (Summary)**
                        
                        **Indication:**
                          - Predicted or encountered difficulty with bag-mask ventilation or endotracheal intubation.
                        **Checklist:**
                          1. Call for help early and prepare difficult airway trolley.
                          2. Optimize positioning and pre-oxygenation.
                          3. Attempt intubation with most experienced operator; use video laryngoscopy when available.
                          4. Limit number of attempts; use bougie on difficult laryngoscopy.
                          5. If intubation fails but ventilation possible $\rightarrow$ consider awake techniques, fiberoptic, or supraglottic device.
                          6. If cannot ventilate/oxygenate $\rightarrow$ perform emergency cricothyroidotomy per instititutional guideline.
                    </div>
                </div>

                <!-- Protocol Dropdown 2C -->
                <div id="protocol-2C" class="border border-gray-200 rounded-lg">
                    <div onclick="toggleProtocol('protocol-2C-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-blue-700 text-sm">
                        C) Extubation Criteria & Weaning Checklist
                        <span class="text-lg">‚ñº</span>
                    </div>
                    <div id="protocol-2C-content" class="protocol-content p-4 bg-white text-xs whitespace-pre-wrap">
                        **C. Extubation Criteria $\&$ Weaning Checklist**

                        **Indication:**
                          - Patient showing readiness for liberation from mechanical ventilation.
                        **Checklist:**
                          - Hemodynamic stability (no escalating vasopressors), adequate oxygenation and ventilation parameters,
                            manageable secretions, intact airway protective reflexes, adequate mental status.
                          - Perform Spontaneous Breathing Trial (SBT): $30-120$ minutes on CPAP $\le 5$ cmH$_2$O or T-piece.
                          - Use RSBI (Rapid Shallow Breathing Index = RR / tidal volume (L)) $\le 105$ as supportive metric.
                          - If SBT passed $\rightarrow$ perform cuff leak test if airway edema risk; proceed with extubation.
                        **Post-extubation Orders:**
                          - Apply supplemental oxygen (HFNC or mask) as required; monitor respiratory status closely;
                            arrange chest physiotherapy and swallowing assessment if needed.
                    </div>
                </div>

                <!-- Protocol Dropdown 2D -->
                <div id="protocol-2D" class="border border-gray-200 rounded-lg">
                    <div onclick="toggleProtocol('protocol-2D-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-blue-700 text-sm">
                        D) ARDS Ventilator Protocol (Lung-Protective Ventilation)
                        <span class="text-lg">‚ñº</span>
                    </div>
                    <div id="protocol-2D-content" class="protocol-content p-4 bg-white text-xs whitespace-pre-wrap">
                        **D. ARDS Ventilator Protocol (Lung-Protective Ventilation)**

                        **Indication:**
                          - ARDS: acute hypoxemic respiratory failure with bilateral infiltrates not explained by cardiac failure.
                        **Goals:**
                          - Minimize ventilator-induced lung injury; improve oxygenation.
                        **Checklist:**
                          1. Tidal volume: $6$ mL/kg predicted body weight (PBW) ($4-8$ mL/kg acceptable).
                          2. Plateau pressure: maintain $\le 30$ cmH$_2$O.
                          3. Use ARDSNet PEEP/FiO$_2$ ladder to titrate PEEP and FiO$_2$.
                          4. Target $\text{SpO}_2$ $88-95\%$ or $\text{PaO}_2$ $55-80$ mmHg (individualize).
                          5. Permissive hypercapnia allowed if pH $\ge 7.15$.
                          6. Prone positioning if $\text{PaO}_2/\text{FiO}_2 < 150$ (for at least $12-16$ hours/day).
                          7. Consider neuromuscular blockade in early severe ARDS if indicated.
                          8. Employ conservative fluid strategy after shock has resolved.
                        **Monitoring:**
                          - ABG, plateau pressures, driving pressure, oxygenation metrics, hemodynamics.
                        **Escalation:**
                          - If refractory hypoxemia $\rightarrow$ consider ECMO referral if available and appropriate.
                    </div>
                </div>

                <!-- Protocol Dropdown 2E -->
                <div id="protocol-2E" class="border border-gray-200 rounded-lg">
                    <div onclick="toggleProtocol('protocol-2E-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-blue-700 text-sm">
                        E) Non-Invasive Ventilation (NIV) Initiation Protocol
                        <span class="text-lg">‚ñº</span>
                    </div>
                    <div id="protocol-2E-content" class="protocol-content p-4 bg-white text-xs whitespace-pre-wrap">
                        **E. Non-Invasive Ventilation (NIV) Initiation Protocol**
                        
                        **Indication:**
                          - Acute hypercapnic respiratory failure (e.g., COPD exacerbation), cardiogenic pulmonary edema,
                            early hypoxemic failure in selected patients.
                        **Checklist:**
                          1. Confirm no contraindications (vomiting, facial trauma, inability to protect airway, severe hypoxemia).
                          2. Choose mask interface and start with IPAP/EPAP settings appropriate to the condition
                             (e.g., IPAP $8-12$, EPAP $4-6$ for COPD exacerbation).
                          3. Monitor ABG at baseline and reassess at $1-2$ hours.
                          4. Escalate to intubation if worsening oxygenation, rising $\text{CO}_2$ with acidosis or clinical fatigue.
                    </div>
                </div>
            </div>

        </div>
    </div>


    <!-- Promotional Footer -->
    <footer class="mt-8 pt-6 border-t border-gray-300 bg-white p-6 rounded-xl card-shadow">
        <h3 class="text-lg font-bold text-gray-800 mb-4">üìö Learn Critical Care with Dr. XzeCure</h3>
        
        <div class="flex flex-col md:flex-row md:space-x-8 space-y-6 md:space-y-0 text-sm">
            
            <!-- Courses and Social -->
            <div class="md:w-1/3">
                <h4 class="font-semibold text-blue-700 mb-2 border-b pb-1">Courses & Social Media</h4>
                <p class="mb-2"><a href="https://wa.link/ex9dxa" target="_blank" class="text-green-600 font-bold hover:underline">Enroll for ICU course, Starting 20/10/25</a></p>
                <p class="mb-2">Follow for more: <a href="https://www.instagram.com/askdr.xze" target="_blank" class="text-pink-600 hover:underline font-medium">IG: @askdr.xze</a></p>
                <p class="mb-2">All Links: <a href="https://linktr.ee/xzecure" target="_blank" class="text-gray-600 hover:underline">https://linktr.ee/xzecure</a></p>
            </div>

            <!-- Books & E-books -->
            <div class="md:w-2/3 grid grid-cols-1 sm:grid-cols-3 gap-6">
                
                <!-- Book 1 -->
                <div>
                    <h4 class="font-semibold text-blue-700 mb-2 border-b pb-1">üìò 1. ICU ESSENTIALS</h4>
                    <ul class="space-y-1">
                        <li>Paperback: <a href="https://store.pothi.com/book/dr-kenil-shah-icu-essentials-50-common-case-presentations/" target="_blank" class="text-blue-500 hover:underline">Pothi Store</a></li>
                        <li>Audio: <a href="https://play.google.com/store/audiobooks/details?id=AQAAAEAqIFhgYM" target="_blank" class="text-orange-500 hover:underline">Google Audiobooks</a></li>
                        <li>E-book: <a href="https://amzn.in/d/95JsyRX" target="_blank" class="text-blue-500 hover:underline">Amazon</a> | <a href="https://play.google.com/store/books/details?id=FldpEQAAQBAJ" target="_blank" class="text-blue-500 hover:underline">Google Books</a></li>
                    </ul>
                </div>

                <!-- Book 2 -->
                <div>
                    <h4 class="font-semibold text-blue-700 mb-2 border-b pb-1">üìï 2. Ultimate Interpretation Handbook</h4>
                    <ul class="space-y-1">
                        <li>Pothi: <a href="https://store.pothi.com/book/ebook-dr-kenil-shah-ultimate-interpretation-handbook/" target="_blank" class="text-blue-500 hover:underline">Pothi Store</a></li>
                        <li>E-book: <a href="https://kdp.amazon.com/amazon-dp-action/in/dualbookshelf.marketplacelink/B0FG51YQ52" target="_blank" class="text-blue-500 hover:underline">Amazon</a> | <a href="https://play.google.com/store/books/details?id=7mpsEQAAQBAJ" target="_blank" class="text-blue-500 hover:underline">Google Books</a></li>
                    </ul>
                </div>

                <!-- Book 3 -->
                <div>
                    <h4 class="font-semibold text-blue-700 mb-2 border-b pb-1">üìó 3. Say It Simple</h4>
                    <ul class="space-y-1">
                        <li>Pothi: <a href="https://store.pothi.com/book/ebook-dr-kenil-shah-ultimate-interpretation-handbook/" target="_blank" class="text-blue-500 hover:underline">Pothi Store</a></li>
                        <li>E-book: <a href="https://kdp.amazon.com/amazon-dp-action/in/dualbookshelf.marketplacelink/B0FFMSJZP2" target="_blank" class="text-blue-500 hover:underline">Amazon</a> | <a href="https://play.google.com/store/books/details?id=unRpEQAAQBAJ" target="_blank" class="class="text-blue-500 hover:underline">Google Books</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <p class="text-center text-xs text-gray-500 mt-6">Copyright XzeCure 2025</p>
    </footer>


    <!-- Confirmation Modal (for Management Suggestions) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white p-6 rounded-xl w-full max-w-lg card-shadow">
            <h3 class="text-xl font-bold text-red-700 mb-4 border-b pb-2">üö® Confirm Clinical Action</h3>
            <p id="modal-message" class="mb-4 text-gray-700"></p>
            <p class="text-sm italic text-gray-500 mb-6">Final responsibility lies with the treating clinician. This action will be logged for audit purposes.</p>
            <div class="flex justify-end space-x-3">
                <button onclick="document.getElementById('confirmation-modal').classList.add('hidden')" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button onclick="confirmAction()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                    Confirm & Log
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Global Constants
        const ALGORITHM_VERSION = '3.0.3-ABG-Page-Protocols'; 
        const NORMAL_AG = 12;
        const NORMAL_HCO3 = 24;
        const NORMAL_PCO2 = 40;
        const NORMAL_ALBUMIN_GDL = 4.0;
        const PH_WATER = 47; 
        const RESPIRATORY_QUOTIENT = 0.8; 

        // Define strict normal ranges for primary interpretation
        const REF_PH_MIN = 7.35;
        const REF_PH_MAX = 7.45;
        const REF_PCO2_MIN = 35;
        const REF_PCO2_MAX = 45;
        const REF_HCO3_MIN = 22;
        const REF_HCO3_MAX = 28;

        // --- Utility Functions ---

        /** Returns an ISO 8601 timestamp string. */
        function now_iso() {
            return moment().toISOString();
        }

        // --- View Toggling Functions ---
        function showProtocolsPage() {
            document.getElementById('abg-view').classList.add('hidden');
            document.getElementById('protocol-view').classList.remove('hidden');
        }

        function showCalculatorPage() {
            document.getElementById('protocol-view').classList.add('hidden');
            document.getElementById('abg-view').classList.remove('hidden');
        }

        function toggleProtocolCategory(categoryId) {
            const content = document.getElementById(`protocol-items-${categoryId}`);
            const arrow = document.querySelector(`.arrow-${categoryId}`);

            if (content.classList.contains('hidden')) {
                // Show content
                content.classList.remove('hidden');
                arrow.innerHTML = '‚Üì'; // Down arrow
            } else {
                // Hide content and ensure all sub-protocols are closed
                content.classList.add('hidden');
                arrow.innerHTML = '‚Üí'; // Right arrow
                
                // Close all expandable sub-protocols within this category
                content.querySelectorAll('.protocol-content').forEach(subContent => {
                    subContent.classList.remove('active');
                });
            }
        }
        
        function toggleProtocol(contentId) {
            const content = document.getElementById(contentId);
            const isContentOpen = content.classList.contains('active');

            // Close all other open sub-protocols globally to ensure clean view
            document.querySelectorAll('.protocol-content').forEach(c => {
                if (c.id !== contentId) {
                    c.classList.remove('active');
                }
            });
            
            // Toggle the clicked content
            if (!isContentOpen) {
                content.classList.add('active');
            } else {
                content.classList.remove('active');
            }
        }

        // --- ABG Calculation Functions (omitted for brevity, assume they work as before) ---

        function parseABGInputs() {
            const getVal = (id) => {
                const el = document.getElementById(id);
                const val = parseFloat(el.value);
                return isNaN(val) ? null : val;
            };

            const inputs = {
                pH: getVal('input_pH'), paco2: getVal('input_paco2'), hco3: getVal('input_hco3'),
                pao2: getVal('input_pao2'), fio2: getVal('input_fio2'), na: getVal('input_na'),
                k: getVal('input_k'), cl: getVal('input_cl'), albumin: getVal('input_albumin'),
                lactate: getVal('input_lactate'), age: getVal('input_age'), pb: 760,
            };

            if (inputs.pH === null || inputs.paco2 === null || inputs.hco3 === null) {
                return { error: "pH, PaCO‚ÇÇ, and HCO‚ÇÉ‚Åª are required inputs." };
            }
            if (inputs.pH < 6.8 || inputs.pH > 8.0) {
                return { error: `pH value (${inputs.pH}) is physiologically implausible.` };
            }
            if (inputs.paco2 < 5 || inputs.paco2 > 200) {
                return { error: `PaCO‚ÇÇ value (${inputs.paco2}) is physiologically implausible.` };
            }
            return inputs;
        }

        function interpretABGAlgorithm(input) {
            const { pH, paco2, hco3, pao2, fio2, na, cl, albumin, lactate, age, pb } = input;
            const calc_log = [];
            let mixed = false;
            let compensation = {};
            let ag = null;
            let corrected_ag = null;
            let delta_ratio = null;
            let a_a = null;
            let pf = null;

            // 1. Determine Normal Status
            const isNormal = (pH >= REF_PH_MIN && pH <= REF_PH_MAX) &&
                             (paco2 >= REF_PCO2_MIN && paco2 <= REF_PCO2_MAX) &&
                             (hco3 >= REF_HCO3_MIN && hco3 <= REF_HCO3_MAX);

            if (isNormal) {
                return {
                    primary_diagnoses: [{ label: "Normal Acid-Base Status", confidence: 1.0, rationale: "All primary ABG parameters are within strict reference ranges." }],
                    mixed_disorder_detected: false,
                    anion_gap: { value: null, corrected: null },
                    delta_ratio: null, a_a_gradient: null, pf_ratio: null,
                    management_suggestions: [{ urgency: 'routine', action: 'Routine monitoring and follow up as clinically indicated.' }],
                    calculation_log: ["1. All primary ABG values (pH, PaCO2, HCO3) are within the normal reference range."],
                    confidence_score: 1.0,
                    timestamp: now_iso(),
                    algorithm_version: ALGORITHM_VERSION
                };
            }


            // 2. Continue full interpretation if not perfectly normal
            let acid_base_state = "near-normal";
            if (pH < REF_PH_MIN) acid_base_state = "acidosis";
            else if (pH > REF_PH_MAX) acid_base_state = "alkalosis";
            calc_log.push(`1. pH -> ${pH.toFixed(2)} => ${acid_base_state}`);

            const paCO2_dir = paco2 > REF_PCO2_MAX ? "high" : (paco2 < REF_PCO2_MIN ? "low" : "normal");
            const HCO3_dir = hco3 > REF_HCO3_MAX ? "high" : (hco3 < REF_HCO3_MIN ? "low" : "normal");
            calc_log.push(`2. PaCO2 ${paco2} (${paCO2_dir}), HCO3 ${hco3} (${HCO3_dir})`);

            let primary_candidates = [];
            if (acid_base_state === "acidosis") {
                if (paCO2_dir === "high") primary_candidates.push("Respiratory Acidosis");
                if (HCO3_dir === "low") primary_candidates.push("Metabolic Acidosis");
            } else if (acid_base_state === "alkalosis") {
                if (paCO2_dir === "low") primary_candidates.push("Respiratory Alkalosis");
                if (HCO3_dir === "high") primary_candidates.push("Metabolic Alkalosis");
            }
            
            let ag_check_value = null;
            if (na !== null && cl !== null) {
                ag = na - (cl + hco3);
                ag_check_value = ag;
                calc_log.push(`3. Anion Gap (AG): ${ag.toFixed(1)}`);

                if (albumin !== null) {
                    const ag_correction = 2.5 * (NORMAL_ALBUMIN_GDL - albumin);
                    corrected_ag = ag + ag_correction;
                    ag_check_value = corrected_ag;
                    calc_log.push(`   Albumin Correction: ${ag_correction.toFixed(1)}`);
                    calc_log.push(`   Corrected AG: ${corrected_ag.toFixed(1)}`);
                }

                if (ag_check_value > NORMAL_AG + 2) { 
                    if (primary_candidates.includes("Metabolic Acidosis") === false && HCO3_dir === "low") {
                        primary_candidates.push("High AG Metabolic Acidosis"); 
                    } else if (primary_candidates.includes("Metabolic Acidosis")) {
                        primary_candidates[primary_candidates.indexOf("Metabolic Acidosis")] = "High AG Metabolic Acidosis";
                    }
                    
                    const deltaAG = ag_check_value - NORMAL_AG;
                    const deltaHCO3 = NORMAL_HCO3 - hco3;
                    
                    if (deltaHCO3 !== 0) {
                        delta_ratio = parseFloat((deltaAG / deltaHCO3).toFixed(2));
                        calc_log.push(`   Delta Ratio (ŒîAG/ŒîHCO3): ${delta_ratio}`);
                    }
                }
            }

            const tolerance = 2.0;
            if (primary_candidates.some(c => c.includes("Metabolic Acidosis"))) {
                const expected_paco2_min = (1.5 * hco3 + 8) - tolerance;
                const expected_paco2_max = (1.5 * hco3 + 8) + tolerance;
                let status;
                if (paco2 >= expected_paco2_min && paco2 <= expected_paco2_max) status = "appropriate";
                else if (paco2 > expected_paco2_max) { status = "inappropriate - concurrent Resp Acidosis"; mixed = true; }
                else { status = "inappropriate - concurrent Resp Alkalosis"; mixed = true; }
                compensation.metabolic_acidosis_winter = { expected_paco2_range: `${expected_paco2_min.toFixed(1)} - ${expected_paco2_max.toFixed(1)}`, observed_vs_expected: status };
                calc_log.push(`4. Compensation Check (Met Acidosis): PaCO2 expected ${compensation.metabolic_acidosis_winter.expected_paco2_range} -> ${status}`);
            }
            
            if (primary_candidates.includes("Respiratory Acidosis")) {
                const delta_pco2 = paco2 - NORMAL_PCO2;
                const expected_hco3_acute = NORMAL_HCO3 + (1 * (delta_pco2 / 10));
                const expected_hco3_chronic = NORMAL_HCO3 + (3.5 * (delta_pco2 / 10));
                let status;
                const diff_acute = Math.abs(hco3 - expected_hco3_acute);
                const diff_chronic = Math.abs(hco3 - expected_hco3_chronic);
                if (diff_acute < 3) status = "appropriate - acute";
                else if (diff_chronic < 3) status = "appropriate - chronic";
                else { status = "inappropriate - consider mixed"; mixed = true; }
                compensation.respiratory_acidosis = { expected_hco3_acute: parseFloat(expected_hco3_acute.toFixed(1)), expected_hco3_chronic: parseFloat(expected_hco3_chronic.toFixed(1)), observed_vs_expected: status };
                calc_log.push(`4. Compensation Check (Resp Acidosis): HCO3 acute expected ${compensation.respiratory_acidosis.expected_hco3_acute}, chronic ${compensation.respiratory_acidosis.expected_hco3_chronic} -> ${status}`);
            }

            if (acid_base_state === "near-normal" && primary_candidates.length === 0) {
                if (paco2_dir === "high" && HCO3_dir === "high") {
                    primary_candidates.push("Chronic Respiratory Acidosis (Fully Compensated)");
                } else if (paco2_dir === "low" && HCO3_dir === "low") {
                    primary_candidates.push("Chronic Respiratory Alkalosis (Fully Compensated)");
                } else if (paCO2_dir !== "normal" || HCO3_dir !== "normal") {
                    primary_candidates.push("Fully Compensated Disorder (Requires context)");
                } else {
                    primary_candidates.push("Normal Acid-Base Status (Minimal Derangement)"); 
                }
            } else if (primary_candidates.length === 0) {
                 primary_candidates.push("Indeterminate Primary Disturbance");
            }

            let aa_interpret = null;
            let pf_interpret = null;
            let normal_Aa = null;

            if (pao2 !== null && fio2 !== null && fio2 >= 0.21 && fio2 <= 1.0) {
                const PAO2 = fio2 * (pb - PH_WATER) - (paco2 / RESPIRATORY_QUOTIENT);
                const A_a_value = PAO2 - pao2;
                a_a = { value: parseFloat(A_a_value.toFixed(1)) };
                
                normal_Aa = age !== null ? (age / 4.0) + 4.0 : 10.0;
                a_a.normal_for_age = parseFloat(normal_Aa.toFixed(1));

                if (A_a_value <= normal_Aa) { aa_interpret = "A-a gradient is normal (Hypoventilation or normal gas exchange)."; } 
                else { aa_interpret = "A-a gradient is elevated (V/Q mismatch or shunt likely)."; }
                a_a.interpretation = aa_interpret;
                calc_log.push(`5. A-a Gradient: ${a_a.value} (Normal < ${a_a.normal_for_age}) -> ${aa_interpret}`);


                const PF_VALUE = pao2 / fio2;
                pf = { value: parseFloat(PF_VALUE.toFixed(1)) };
                
                if (PF_VALUE < 100) pf_interpret = "Severe hypoxemia (ARDS criteria severe)";
                else if (PF_VALUE < 200) pf_interpret = "Moderate hypoxemia (ARDS criteria moderate)";
                else if (PF_VALUE < 300) pf_interpret = "Mild hypoxemia (ARDS criteria mild)";
                else pf_interpret = "Normal oxygenation";
                pf.interpretation = pf_interpret;
                calc_log.push(`   P/F Ratio: ${pf.value} -> ${pf_interpret}`);
            }
            
            const mgmt = [];
            if (pf && pf.value < 200) { mgmt.push({ urgency: 'immediate', action: `Optimize oxygenation: PF ratio (${pf.value}) suggests Moderate-Severe Hypoxemia. Increase FiO2/PEEP, consider Prone Positioning.` }); }
            if (paco2 > 60 && pH < 7.25 && primary_candidates.includes("Respiratory Acidosis")) { mgmt.push({ urgency: 'immediate', action: 'Severe Respiratory Acidosis: Increase minute ventilation or prepare for intubation.' }); }
            if (ag_check_value > NORMAL_AG + 2 && ag_check_value !== null) { mgmt.push({ urgency: 'urgent', action: 'Investigate High AG Metabolic Acidosis: Check ketones (DKA), renal function, toxicology.' }); }
            if (lactate !== null && lactate > 4.0) { mgmt.push({ urgency: 'immediate', action: `Severe Lactic Acidosis (Lactate ${lactate}): Initiate immediate volume resuscitation and address source of shock.` }); }
            mgmt.push({ urgency: 'follow-up', action: 'Repeat ABG after critical interventions in 30‚Äì60 minutes or sooner if unstable.' });
            
            let max_confidence = 0.6;
            const final_diagnosis_list = primary_candidates.map(cand => {
                const ph_dev = Math.abs(7.4 - pH);
                let conf = Math.min(0.95, 0.4 + ph_dev * 0.8);
                max_confidence = Math.max(max_confidence, conf);
                return { label: cand, confidence: parseFloat(conf.toFixed(2)), rationale: `pH ${acid_base_state}, PaCO2 ${paCO2_dir}, HCO3 ${HCO3_dir}.` };
            });

            if (mixed) {
                final_diagnosis_list.push({ label: 'Mixed Acid-Base Disorder Confirmed', confidence: 0.85, rationale: 'Compensation limits exceeded or conflicting primary changes detected.' });
            }

            const confidence = Math.max(0.1, Math.min(0.99, max_confidence));

            return {
                primary_diagnoses: final_diagnosis_list,
                mixed_disorder_detected: mixed,
                compensation_status: compensation,
                anion_gap: { value: ag, corrected: corrected_ag },
                delta_ratio: delta_ratio,
                a_a_gradient: a_a,
                pf_ratio: pf,
                management_suggestions: mgmt,
                calculation_log: calc_log,
                confidence_score: parseFloat(confidence.toFixed(2)),
                timestamp: now_iso(),
                algorithm_version: ALGORITHM_VERSION
            };
        }

        async function interpretABG() {
            document.getElementById('abg-loading').classList.remove('hidden');
            document.getElementById('abg-output').classList.add('hidden');
            document.getElementById('abg-error').classList.add('hidden');
            document.getElementById('abg-message').classList.add('hidden'); 
            document.getElementById('toggle-log').classList.add('hidden');
            document.getElementById('calculation-log').classList.add('hidden');

            const inputs = parseABGInputs();
            if (inputs.error) {
                document.getElementById('abg-error').innerText = inputs.error;
                document.getElementById('abg-error').classList.remove('hidden');
                document.getElementById('abg-loading').classList.add('hidden');
                return;
            }

            try {
                const result = interpretABGAlgorithm(inputs);
                const summaryDiv = document.getElementById('result-summary');
                const primaryDiag = result.primary_diagnoses[0];

                let isNormal = primaryDiag.label.includes('Normal Acid-Base Status');
                let backgroundClass = isNormal ? 'bg-green-100 border border-green-300' : 
                                      (result.mixed_disorder_detected || inputs.pH < REF_PH_MIN || inputs.pH > REF_PH_MAX ? 'bg-red-100 border border-red-300' : 'bg-blue-100 border border-blue-300');
                let textColor = isNormal ? 'text-green-700' : 'text-blue-900';

                let html = `
                    <div class="space-y-4">
                        <div class="p-4 rounded-xl ${backgroundClass}">
                            <h3 class="font-bold text-xl ${textColor}">
                                Primary Finding: <span class="font-extrabold">${primaryDiag.label}</span>
                                <span class="text-sm font-normal text-gray-600">(Conf: ${result.confidence_score})</span>
                            </h3>
                            ${result.primary_diagnoses.slice(1).map(d => `<p class="text-sm italic text-red-600 ml-1">Mixed/Secondary: ${d.label}</p>`).join('')}
                        </div>
                        
                        <h4 class="font-semibold text-gray-700 mt-4">Key Metrics:</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm p-3 border rounded-lg bg-gray-50">
                            <div><span class="font-medium text-gray-600">pH / State:</span> <span class="font-bold">${inputs.pH}</span></div>
                            <div><span class="font-medium text-gray-600">PaCO‚ÇÇ:</span> <span class="font-bold">${inputs.paco2} mmHg</span></div>
                            <div><span class="font-medium text-gray-600">HCO‚ÇÉ‚Åª:</span> <span class="font-bold">${inputs.hco3} mmol/L</span></div>
                            <div><span class="font-medium text-gray-600">AG (Corrected):</span> <span class="font-bold">${result.anion_gap.corrected !== null ? result.anion_gap.corrected.toFixed(1) : (result.anion_gap.value !== null ? result.anion_gap.value.toFixed(1) : 'N/A')}</span></div>
                            ${result.delta_ratio ? `<div><span class="font-medium text-gray-600">Delta Ratio:</span> <span class="font-bold text-orange-600">${result.delta_ratio}</span></div>` : ''}
                            ${result.pf_ratio ? `<div><span class="font-medium text-gray-600">PF Ratio:</span> <span class="font-bold ${result.pf_ratio.value < 300 ? 'text-red-600' : 'text-green-600'}">${result.pf_ratio.value}</span></div>` : ''}
                            ${result.a_a_gradient ? `<div><span class="font-medium text-gray-600">A-a Grad:</span> <span class="font-bold">${result.a_a_gradient.value} mmHg</span></div>` : ''}
                            ${inputs.lactate ? `<div><span class="font-medium text-gray-600">Lactate:</span> <span class="font-bold ${inputs.lactate > 4.0 ? 'text-red-700' : (inputs.lactate > 2.0 ? 'text-orange-600' : 'text-green-600')}">${inputs.lactate} mmol/L</span></div>` : ''}
                        </div>

                        ${isNormal ? '' : `<h4 class="font-semibold text-gray-700 pt-3">Suggested Management Actions:</h4>
                        <ul class="list-disc ml-5 text-sm space-y-1">
                            ${result.management_suggestions.map(m => 
                                `<li class="${m.urgency === 'immediate' ? 'text-red-600 font-bold' : m.urgency === 'urgent' ? 'text-orange-600' : 'text-gray-700'}">
                                    <span class="font-bold uppercase text-xs">${m.urgency}:</span> ${m.action}
                                    <button onclick="showConfirmationModal('${m.action}')" class="ml-2 px-2 py-0.5 text-xs bg-red-100 text-red-600 rounded-full hover:bg-red-200 shadow-sm">Confirm</button>
                                </li>`).join('')}
                        </ul>`}
                    </div>
                `;
                
                summaryDiv.innerHTML = html;
                document.getElementById('calculation-log').innerText = result.calculation_log.join('\n');
                document.getElementById('toggle-log').classList.remove('hidden');

            } catch (e) {
                console.error("ABG Interpretation Error:", e);
                document.getElementById('abg-error').innerText = "An unexpected error occurred during calculation. Please check inputs.";
                document.getElementById('abg-error').classList.remove('hidden');
            } finally {
                document.getElementById('abg-loading').classList.add('hidden');
                document.getElementById('abg-output').classList.remove('hidden');
            }
        }

        function toggleCalculationLog() {
            const log = document.getElementById('calculation-log');
            const button = document.getElementById('toggle-log');
            if (log.classList.contains('hidden')) {
                log.classList.remove('hidden');
                button.innerText = 'Hide Calculation Log';
            } else {
                log.classList.add('hidden');
                button.innerText = 'Show Calculation Log';
            }
        }

        function showConfirmationModal(action) {
            document.getElementById('modal-message').innerHTML = `You are confirming the following action for audit: <br><br><strong class="text-lg">${action}</strong>`;
            document.getElementById('confirmation-modal').classList.remove('hidden');
            window.currentAction = action; 
        }

        function confirmAction() {
            const action = window.currentAction || "Unknown Action";
            console.log(`[AUDIT LOG - ${now_iso()}] User confirmed action: ${action}`);
            document.getElementById('confirmation-modal').classList.add('hidden');
            
            const msgDiv = document.getElementById('abg-message');
            const displayAction = action.length > 70 ? action.substring(0, 70) + '...' : action;
            msgDiv.innerHTML = `‚úÖ **Audit Logged**: Confirmed action: *${displayAction}*`;
            msgDiv.classList.remove('hidden');

            setTimeout(() => {
                msgDiv.classList.add('hidden');
            }, 5000);
        }
        
        // Initial setup on load
        window.onload = function() {
            interpretABG(); 
        };

    </script>
</body>
</html>


