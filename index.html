<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XzeCure ICU tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        /* 1. Color Palette & Typography */
        :root {
            --bg-primary: #121212;
            --bg-card: #1E1E1E;
            --accent-teal: #00BFA6;
            --accent-teal-light: #1DE9B6;
            --accent-blue: #2979FF;
            --text-white: #FFFFFF;
            --text-light: #E0E0E0;
            --text-muted: #9E9E9E;
            --color-error: #FF5252;
            --color-success: #00E676;
            --color-warning: #FFC107;
            --border-dark: #2C2C2C;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-light);
        }

        h1, h2, h3, h4, .protocol-category {
            font-family: 'Poppins', sans-serif;
            color: var(--text-white);
        }
        
        .card-panel {
            background-color: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6), 0 0 1px var(--border-dark) inset;
            border: 1px solid var(--border-dark);
            transition: box-shadow 0.3s ease;
        }
        
        /* Input Styling */
        input[type="number"], input[type="text"] {
            background-color: var(--bg-card);
            color: var(--text-light);
            border: 1px solid var(--border-dark);
            border-radius: 4px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="number"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-teal);
            box-shadow: 0 0 0 2px rgba(0, 191, 166, 0.4); /* Teal glow */
        }
        input::placeholder {
            color: var(--text-muted);
        }

        /* Button Styling */
        .btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
            border: 1px solid transparent;
        }
        
        .btn-primary {
            background-color: var(--accent-teal);
            color: var(--bg-primary); /* Dark text on bright background */
        }
        .btn-primary:hover {
            background-color: var(--accent-teal-light);
            box-shadow: 0 0 10px rgba(0, 191, 166, 0.8);
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--accent-teal);
            border-color: var(--accent-teal);
        }
        .btn-secondary:hover {
            background-color: var(--accent-teal);
            color: var(--bg-primary);
            box-shadow: 0 0 10px rgba(0, 191, 166, 0.2);
        }
        
        .btn-error {
            background-color: var(--color-error);
            color: var(--text-white);
        }
        .btn-error:hover {
            background-color: #D32F2F;
        }

        /* Protocol/Accordion Styling */
        .protocol-category {
            cursor: pointer;
            background-color: var(--border-dark);
            border-left: 5px solid var(--accent-teal);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 6px;
            transition: background-color 0.2s, transform 0.2s;
            font-size: 1.25rem;
        }
        .protocol-category:hover {
            background-color: #2C2C2C;
            transform: translateY(-1px);
        }
        
        .protocol-item {
            cursor: pointer;
            transition: background-color 0.15s;
            background-color: var(--bg-card);
            border: 1px solid var(--border-dark);
            border-radius: 4px;
        }
        .protocol-item:hover {
            background-color: #252525;
        }
        
        .protocol-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            color: var(--text-light);
        }
        .protocol-content.active {
            max-height: 2000px; 
        }

        /* Utility Overrides for Dark Mode */
        .text-red-600 { color: var(--color-error); }
        .bg-red-600 { background-color: var(--color-error); }
        .text-blue-900 { color: var(--accent-teal-light); }
        .text-blue-700 { color: var(--accent-teal); }
        .text-gray-700 { color: var(--text-light); }
        .text-gray-600 { color: var(--text-muted); }

    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 flex flex-col min-h-screen">

    <!-- Header and Emergency Button -->
    <header class="mb-6 card-panel p-4 flex flex-col md:flex-row justify-between items-center">
        <!-- Logo and Title Block -->
        <div class="flex items-center space-x-4">
            <img src="logo.png" alt="XzeCure Logo" class="h-14 w-14 rounded-full border-2 border-teal-500 hidden sm:block" onerror="this.onerror=null; this.src='https://placehold.co/80x80/00BFA6/121212?text=ICU'">
            <div>
                <h1 class="text-3xl font-bold text-white">XzeCure ICU tool</h1>
            </div>
        </div>
        
        <!-- Emergency Button - Uses Error Styling -->
        <a href="https://api.whatsapp.com/send?phone=918200095781&text=My%20Patient%20needs%20urgent%20ICU%20care.%20Where%20can%20we%20refer%3F" 
           target="_blank"
           class="mt-4 md:mt-0 btn btn-error shadow-lg whitespace-nowrap">
            üö® Emergency (Refer to ICU)
        </a>
    </header>

    <!-- MAIN APP CONTAINER -->
    <div class="flex-grow">
        
        <!-- ABG CALCULATOR VIEW -->
        <div id="abg-view" class="card-panel p-4 sm:p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-teal-500 border-b border-gray-700 pb-2">ABG Interpretation and Metabolic Status</h2>
            
            <!-- ABG Inputs -->
            <div id="abg-inputs" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-400">pH <span class="text-red-500">*</span></label><input type="number" id="input_pH" value="7.18" step="0.01" class="w-full p-2 text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-400">PaCO‚ÇÇ (mmHg) <span class="text-red-500">*</span></label><input type="number" id="input_paco2" value="28" class="w-full p-2 text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-400">HCO‚ÇÉ‚Åª (mmol/L) <span class="text-red-500">*</span></label><input type="number" id="input_hco3" value="8" class="w-full p-2 text-sm"></div>
                
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-400">Na (mmol/L)</label><input type="number" id="input_na" value="135" class="w-full p-2 text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-400">Cl (mmol/L)</label><input type="number" id="input_cl" value="95" class="w-full p-2 text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-400">K (mmol/L)</label><input type="number" id="input_k" value="4.5" class="w-full p-2 text-sm"></div>
                
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-400">PaO‚ÇÇ (mmHg)</label><input type="number" id="input_pao2" value="90" class="w-full p-2 text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-400">FiO‚ÇÇ (0.21 - 1.0)</label><input type="number" id="input_fio2" value="0.21" step="0.01" class="w-full p-2 text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-400">Age (Years)</label><input type="number" id="input_age" value="30" class="w-full p-2 text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-400">Albumin (g/dL)</label><input type="number" id="input_albumin" value="4.0" step="0.1" class="w-full p-2 text-sm"></div>
                <div class="col-span-1"><label class="block text-xs font-medium text-gray-400">Lactate (mmol/L)</label><input type="number" id="input_lactate" value="3.2" step="0.1" class="w-full p-2 text-sm"></div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 mb-4">
                <button onclick="interpretABG()" class="w-full sm:w-2/3 btn btn-primary">
                    Interpret ABG & Metabolic Status
                </button>
                <button onclick="showProtocolsPage()" class="w-full sm:w-1/3 btn btn-secondary relative">
                    View Protocols 
                    <span class="absolute top-0 right-0 -mt-2 -mr-2 px-2 py-0.5 text-xs font-bold leading-none bg-red-600 rounded-full" style="background-color: var(--color-error); color: var(--text-white);">NEW</span>
                </button>
            </div>

            <!-- Loading Indicator & Error Message -->
            <div id="abg-loading" class="hidden text-center text-teal-400 font-medium my-4">Analyzing complex acid-base interactions...</div>
            <div id="abg-error" class="text-red-500 text-sm hidden p-3 rounded-md mb-4 border border-red-500" style="background-color: #301818;"></div>

            <!-- Results Output -->
            <div id="abg-output" class="mt-6 pt-4 hidden border-t border-gray-700">
                <div id="result-summary"></div>
                <button id="toggle-log" onclick="toggleCalculationLog()" class="mt-3 text-sm font-medium text-teal-500 hover:text-teal-400">Show Calculation Log</button>
                <div id="calculation-log" class="mt-3 p-3 rounded-lg text-xs hidden whitespace-pre-wrap overflow-x-auto" style="background-color: #252525; color: var(--text-muted);"></div>
            </div>
        </div>

        <!-- PROTOCOLS PAGE VIEW -->
        <div id="protocol-view" class="card-panel p-4 sm:p-6 mb-8 hidden">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-2xl font-bold text-white">Clinical Protocols</h3>
                <button onclick="showCalculatorPage()" class="btn btn-secondary text-sm">
                    ‚Üê Back to Calculator
                </button>
            </div>
            
            <!-- Protocol Category 1: RESUSCITATION & CODE BLUE -->
            <div id="protocol-category-1" onclick="toggleProtocolCategory('1')" class="protocol-category">
                1) RESUSCITATION & CODE BLUE <span class="float-right text-lg arrow-1">‚Üí</span>
            </div>
            <div id="protocol-items-1" class="protocol-category-items border border-gray-700 p-3 rounded-lg mb-4 hidden space-y-2" style="background-color: #121212;">
                <!-- Protocols 1A, 1B, 1C content goes here (structure is kept from previous step) -->
                <div id="protocol-1A" class="rounded-lg overflow-hidden">
                    <div onclick="toggleProtocol('protocol-1A-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">A (ACLS ALGORITHM)<span class="text-lg text-teal-500">‚ñº</span></div>
                    <div id="protocol-1A-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">
                        **A. ACLS ‚Äî Adult Cardiac Arrest Algorithm**
                        
                        **Indication:**
                          - Unresponsive patient, absent or abnormal breathing (agonal), and no palpable pulse.
                        **Goal:**
                          - Achieve return of spontaneous circulation (ROSC) with high-quality CPR, timely defibrillation
                            (if indicated), and management of reversible causes.
                        **Preparation / Equipment:**
                          - CPR team: team leader, chest compressor(s), airway operator, IV/IO access operator, scribe.
                          - Defibrillator/AED, airway kit (BVM, laryngoscope, ETT, supraglottic devices, bougie),
                            suction, resuscitation drugs (epinephrine, amiodarone, lidocaine), capnography, monitors.
                        **Step-by-step Checklist:**
                          1. Ensure scene safety and assess responsiveness. Call for help / activate code.
                          2. Start high-quality CPR immediately (compression rate 100‚Äì120/min; depth 5‚Äì6 cm;
                             allow full chest recoil). Rotate compressors every 2 minutes.
                          3. Attach monitor/defibrillator as soon as available and analyze rhythm.
                          4. **If shockable rhythm (VF / pulseless VT):**
                             - Deliver immediate unsynchronized shock (biphasic device energy per manufacturer).
                             - Resume CPR immediately for 2 minutes without interrupting compressions.
                             - After 2 minutes, check rhythm and pulse; repeat shock if shockable.
                             - Give epinephrine 1 mg IV/IO every 3‚Äì5 minutes (as soon as vascular access available).
                             - Consider amiodarone 300 mg IV bolus after the 3rd shock (repeat 150 mg if needed).
                          5. **If non-shockable rhythm (PEA / asystole):**
                             - Continue CPR in 2-minute cycles.
                             - Give epinephrine 1 mg IV/IO as soon as soon as possible; repeat q3‚Äì5 min.
                             - Identify and treat reversible causes (Hs & Ts).
                          6. **Airway management:** secure advanced airway when feasible (ETT or supraglottic).
                             - Once advanced airway placed: continuous CPR with ventilation rate ~10 breaths/min
                               (1 breath every 6 seconds) and continuous capnography monitoring.
                          7. **Reversible causes:** evaluate and treat Hs & Ts:
                             - **Hypovolemia, Hypoxia, Hydrogen ion (acidosis), Hypo/Hyperkalemia, Hypothermia.**
                             - **Tension pneumothorax, Tamponade (cardiac), Toxins, Thrombosis (pulmonary/coronary).**
                          8. **If ROSC achieved:**
                             - Implement post-cardiac arrest care: maintain oxygenation (SpO‚ÇÇ 92‚Äì98%), target MAP ‚â• 65 mmHg,
                               consider targeted temperature management (TTM) if comatose, and identify & treat cause.
                        **Orders & Monitoring:**
                          - Continuous ECG, SpO‚ÇÇ, EtCO‚ÇÇ; ABG analysis; immediate CXR after stabilization;
                            labs: electrolytes, glucose, CBC, coagulation, troponin; consider urgent coronary angiography
                            if STEMI suspected.
                        **Escalation / When to Call Senior:**
                          - If prolonged arrests, refractory VF/VT after multiple shocks, or complex reversible causes ‚Äî
                            call ICU consultant, cardiology, and consider ECMO team if available.
                        **Notes:**
                          - Minimize interruptions to chest compressions; prioritize high-quality CPR and early defibrillation.
                          - Document times (compressions start, shocks, drug doses, ROSC).
                    </div>
                </div>
                <div id="protocol-1B" class="rounded-lg overflow-hidden">
                    <div onclick="toggleProtocol('protocol-1B-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">B (BLS ALGORITHM)<span class="text-lg text-teal-500">‚ñº</span></div>
                    <div id="protocol-1B-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">
                        **B. BLS (Basic Life Support) for Healthcare Providers**

                        **Indication:**
                          - Unresponsive patient with absent or abnormal breathing.
                        **Checklist:**
                          - Check responsiveness; shout for help; open airway and check breathing (no more than 10 sec).
                          - Call for code / activate emergency response.
                          - Start high-quality CPR: single rescuer adult 30 compressions : 2 breaths.
                          - Attach AED / defibrillator and follow prompts; resume CPR immediately after shock.
                        **Notes:**
                          - With two rescuers and advanced airway in place, give continuous compressions with 1 breath every 6 sec.
                    </div>
                </div>
                <div id="protocol-1C" class="rounded-lg overflow-hidden">
                    <div onclick="toggleProtocol('protocol-1C-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">C (Post cardiac arrest)<span class="text-lg text-teal-500">‚ñº</span></div>
                    <div id="protocol-1C-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">
                        **C. Post-Cardiac Arrest Care (Immediate)**

                        **Goals:**
                          - Optimize oxygenation and perfusion; prevent secondary brain injury; treat underlying cause.
                        **Checklist:**
                          1. Maintain oxygenation: target SpO‚ÇÇ 92‚Äì98% (avoid hyperoxia).
                          2. Hemodynamic support: maintain MAP ‚â• 65 mmHg (titrate vasopressors ‚Äî norepinephrine first-line).
                          3. Obtain 12-lead ECG; if STEMI ‚Üí consult cardiology for immediate reperfusion (PCI) if appropriate.
                          4. Consider targeted temperature management (TTM) for comatose survivors per local protocol.
                          5. Continue neurological monitoring and send neuroimaging as indicated.
                        **Monitoring & Orders:**
                          - Frequent neuro checks, continuous cardiac monitoring, ABG, electrolytes, lactate, urine output.
                        **Notes:**
                          - Post-arrest care is multidisciplinary; early involvement of cardiology and neurology may be critical.
                    </div>
                </div>
            </div>

            <!-- Protocol Category 2: AIRWAY & VENTILATION -->
            <div id="protocol-category-2" onclick="toggleProtocolCategory('2')" class="protocol-category">
                2) AIRWAY & VENTILATION <span class="float-right text-lg arrow-2">‚Üí</span>
            </div>
            <div id="protocol-items-2" class="protocol-category-items border border-gray-700 p-3 rounded-lg mb-4 hidden space-y-2" style="background-color: #121212;">
                 <!-- Protocols 2A - 2E content goes here -->
                <div id="protocol-2A" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-2A-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">A) Rapid Sequence Intubation (RSI) Checklist (Adult)<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-2A-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**A. Rapid Sequence Intubation (RSI) Checklist (Adult)**
                        
                        **Indication:**
                          - Need for definitive airway due to respiratory failure, loss of airway protection, GCS ‚â§ 8,
                            or anticipated deterioration.
                        **Goal:**
                          - Secure airway rapidly and safely while minimizing hypoxia and hemodynamic compromise.
                        **Preparation / Equipment:**
                          - RSI kit: laryngoscope (direct/video), ETTs in appropriate sizes, stylet/bougie, suction,
                            BVM with PEEP, capnography, oxygen source, backup supraglottic devices (LMA), surgical airway kit.
                          - Assign roles: airway operator, assistant, drug nurse, airway assistant, scribe.
                        **Step-by-step Checklist:**
                          1. Pre-oxygenate for 3‚Äì5 minutes with 100% O‚ÇÇ (consider HFNC + NRB or BVM with PEEP).
                          2. Position patient (ramp position for obese; sniffing position as indicated).
                          3. Prepare and check all equipment; ensure functioning suction and capnography.
                          4. Prepare induction agent and paralytic (e.g., etomidate 0.2‚Äì0.3 mg/kg or ketamine 1‚Äì2 mg/kg;
                             succinylcholine 1‚Äì1.5 mg/kg or rocuronium 1 mg/kg ‚Äî choose per hemodynamic status and contraindications).
                          5. Pre-treatment if indicated (e.g., fentanyl to blunt sympathetic response; atropine in infants).
                          6. Perform intubation attempt (limit to maximum 2‚Äì3 attempts by experienced operators).
                          7. If first-pass fails ‚Üí consider repositioning, use bougie, video laryngoscope, or change operator.
                          8. If cannot intubate and cannot ventilate ‚Üí proceed to supraglottic airway and call for emergency surgical airway.
                          9. Confirm tube placement with continuous waveform capnography, chest rise, and auscultation.
                         10. Secure tube and document insertion depth and confirmation method.
                        **Post-intubation Management:**
                          - Start mechanical ventilation with appropriate initial settings (e.g., lung-protective strategy if ARDS risk).
                          - Start sedation & analgesia; monitor BP and HR; obtain CXR to confirm position.
                        **Escalation:**
                          - If oxygenation or ventilation inadequate, call senior ICU/anaesthesia and consider bronchoscopy or surgical airway.</div>
                </div>
                <div id="protocol-2B" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-2B-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">B) Difficult Airway Algorithm<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-2B-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**B. Difficult Airway Algorithm (Summary)**
                        
                        **Indication:**
                          - Predicted or encountered difficulty with bag-mask ventilation or endotracheal intubation.
                        **Checklist:**
                          1. Call for help early and prepare difficult airway trolley.
                          2. Optimize positioning and pre-oxygenation.
                          3. Attempt intubation with most experienced operator; use video laryngoscopy when available.
                          4. Limit number of attempts; use bougie on difficult laryngoscopy.
                          5. If intubation fails but ventilation possible ‚Üí consider awake techniques, fiberoptic, or supraglottic device.
                          6. If cannot ventilate/oxygenate ‚Üí perform emergency cricothyroidotomy per instititutional guideline.</div>
                </div>
                <div id="protocol-2C" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-2C-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">C) Extubation Criteria & Weaning Checklist<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-2C-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**C. Extubation Criteria & Weaning Checklist**

                        **Indication:**
                          - Patient showing readiness for liberation from mechanical ventilation.
                        **Checklist:**
                          - Hemodynamic stability (no escalating vasopressors), adequate oxygenation and ventilation parameters,
                            manageable secretions, intact airway protective reflexes, adequate mental status.
                          - Perform Spontaneous Breathing Trial (SBT): 30‚Äì120 minutes on CPAP ‚â§5 cmH‚ÇÇO or T-piece.
                          - Use RSBI (Rapid Shallow Breathing Index = RR / tidal volume (L)) ‚â§ 105 as supportive metric.
                          - If SBT passed ‚Üí perform cuff leak test if airway edema risk; proceed with extubation.
                        **Post-extubation Orders:**
                          - Apply supplemental oxygen (HFNC or mask) as required; monitor respiratory status closely;
                            arrange chest physiotherapy and swallowing assessment if needed.</div>
                </div>
                <div id="protocol-2D" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-2D-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">D) ARDS Ventilator Protocol (Lung-Protective Ventilation)<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-2D-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**D. ARDS Ventilator Protocol (Lung-Protective Ventilation)**

                        **Indication:**
                          - ARDS: acute hypoxemic respiratory failure with bilateral infiltrates not explained by cardiac failure.
                        **Goals:**
                          - Minimize ventilator-induced lung injury; improve oxygenation.
                        **Checklist:**
                          1. Tidal volume: 6 mL/kg predicted body weight (PBW) (4‚Äì8 mL/kg acceptable).
                          2. Plateau pressure: maintain ‚â§ 30 cmH‚ÇÇO.
                          3. Use ARDSNet PEEP/FiO‚ÇÇ ladder to titrate PEEP and FiO‚ÇÇ.
                          4. Target SpO‚ÇÇ 88‚Äì95% or PaO‚ÇÇ 55‚Äì80 mmHg (individualize).
                          5. Permissive hypercapnia allowed if pH ‚â• 7.15.
                          6. Prone positioning if PaO‚ÇÇ/FiO‚ÇÇ < 150 (for at least 12‚Äì16 hours/day).
                          7. Consider neuromuscular blockade in early severe ARDS if indicated.
                          8. Employ conservative fluid strategy after shock has resolved.
                        **Monitoring:**
                          - ABG, plateau pressures, driving pressure, oxygenation metrics, hemodynamics.
                        **Escalation:**
                          - If refractory hypoxemia ‚Üí consider ECMO referral if available and appropriate.</div>
                </div>
                <div id="protocol-2E" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-2E-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">E) Non-Invasive Ventilation (NIV) Initiation Protocol<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-2E-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**E. Non-Invasive Ventilation (NIV) Initiation Protocol**
                        
                        **Indication:**
                          - Acute hypercapnic respiratory failure (e.g., COPD exacerbation), cardiogenic pulmonary edema,
                            early hypoxemic failure in selected patients.
                        **Checklist:**
                          1. Confirm no contraindications (vomiting, facial trauma, inability to protect airway, severe hypoxemia).
                          2. Choose mask interface and start with IPAP/EPAP settings appropriate to the condition
                             (e.g., IPAP 8‚Äì12, EPAP 4‚Äì6 for COPD exacerbation).
                          3. Monitor ABG at baseline and reassess at 1‚Äì2 hours.
                          4. Escalate to intubation if worsening oxygenation, rising CO‚ÇÇ with acidosis or clinical fatigue.</div>
                </div>
            </div>

            <!-- Protocol Category 3: CIRCULATION & SHOCK MANAGEMENT -->
            <div id="protocol-category-3" onclick="toggleProtocolCategory('3')" class="protocol-category">
                3) CIRCULATION & SHOCK MANAGEMENT <span class="float-right text-lg arrow-3">‚Üí</span>
            </div>
            <div id="protocol-items-3" class="protocol-category-items border border-gray-700 p-3 rounded-lg mb-4 hidden space-y-2" style="background-color: #121212;">
                 <!-- Protocols 3A - 3D content goes here -->
                <div id="protocol-3A" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-3A-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">A. Sepsis / Septic Shock ‚Äî Hour-1 Bundle & Management<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-3A-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**A. Sepsis / Septic Shock ‚Äî Hour-1 Bundle & Management**
                        
                        **Indication:**
                          - Suspected or documented infection with organ dysfunction (qSOFA/SOFA) or septic shock.
                        **Goals:**
                          - Rapid resuscitation to prevent organ failure and mortality.
                        **Checklist (Within 1 Hour):**
                          1. Measure serum lactate; remeasure if initial lactate > 2 mmol/L.
                          2. Obtain blood cultures prior to antibiotics (if this does not cause significant delay).
                          3. Administer broad-spectrum IV antibiotics promptly (choose per suspected source and local antibiogram).
                          4. Begin fluid resuscitation (initial recommendation: 30 mL/kg crystalloid for hypotension or lactate ‚â• 4 mmol/L),
                             individualize in heart failure or renal impairment.
                          5. Start vasopressors (norepinephrine first-line) if persistent hypotension after initial fluid resuscitation;
                             target MAP ‚â• 65 mmHg.
                        **Ongoing:**
                          - Frequent reassessment: urine output, lactate clearance, hemodynamics, and source control procedures as required.
                        **Notes:**
                          - Early de-escalation based on culture results and stewardship review.</div>
                </div>
                <div id="protocol-3B" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-3B-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">B. Vasopressor Initiation & Titration<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-3B-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**B. Vasopressor Initiation & Titration**

                        **Indication:**
                          - Persistent hypotension after initial fluid resuscitation (MAP < 65 mmHg).
                        **Checklist:**
                          1. Start norepinephrine infusion and titrate to target MAP ‚â• 65 mmHg.
                          2. If inadequate response, consider adding vasopressin (0.03 units/min) or epinephrine per protocol.
                          3. Consider insertion of arterial line for continuous blood pressure monitoring.
                        **Monitoring:**
                          - Continuous ECG for arrhythmias, peripheral perfusion, lactate trends, urine output.</div>
                </div>
                <div id="protocol-3C" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-3C-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">C. Fluid Resuscitation Protocol<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-3C-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**C. Fluid Resuscitation Protocol**

                        **Indication:**
                          - Hypovolemia or hypoperfusion states.
                        **Checklist:**
                          1. Give small boluses of crystalloid (e.g., 250‚Äì500 mL) and reassess frequently.
                          2. For sepsis, 30 mL/kg initially (tailor in CHF/CKD patients).
                          3. Use dynamic indices (passive leg raise, stroke volume variation, ultrasound IVC) when available to guide further fluids.
                        **Notes:**
                          - Avoid fluid overload; shift to vasopressors if non-responsive to fluid challenge.</div>
                </div>
                <div id="protocol-3D" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-3D-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">D. Massive Transfusion Protocol (MTP)<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-3D-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**D. Massive Transfusion Protocol (MTP)**

                        **Indication:**
                          - Ongoing hemorrhage with hemodynamic instability or anticipated massive blood loss.
                        **Checklist:**
                          1. Activate MTP per hospital policy and notify blood bank immediately.
                          2. Deliver balanced transfusion packs (commonly 1:1:1 PRBC:FFP:platelets) per institutional protocol.
                          3. Monitor and correct calcium levels, fibrinogen, and maintain normothermia.
                          4. Consider tranexamic acid (TXA) in trauma if within appropriate time window.
                        **Monitoring:**
                          - Frequent ABG, Hb, coagulation profile, fibrinogen, electrolytes.</div>
                </div>
            </div>
            
            <!-- Protocol Category 4: Neurological Emergencies -->
            <div id="protocol-category-4" onclick="toggleProtocolCategory('4')" class="protocol-category">
                4) Neurological Emergencies <span class="float-right text-lg arrow-4">‚Üí</span>
            </div>
            <div id="protocol-items-4" class="protocol-category-items border border-gray-700 p-3 rounded-lg mb-4 hidden space-y-2" style="background-color: #121212;">
                 <!-- Protocols 4A - 4E content goes here -->
                <div id="protocol-4A" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-4A-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">A. Raised Intracranial Pressure (ICP) ‚Äî Tiered Management<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-4A-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**A. Raised Intracranial Pressure (ICP) ‚Äî Tiered Management**
                        
                        **Indication:**
                          - Clinical or measured ICP elevation (trauma, ICH, stroke).
                        **Goals:**
                          - Maintain cerebral perfusion pressure (CPP) and prevent secondary brain injury.
                        **Tier 0 (General Measures):**
                          - Head elevation 30¬∞, neutral neck alignment; avoid neck compression.
                          - Avoid hypoxia and hypotension; maintain normothermia and normoglycemia.
                        **Tier 1:**
                          - Sedation/analgesia; CSF drainage if EVD present; hyperosmolar therapy (3% saline boluses or mannitol 0.25‚Äì1 g/kg if volume status allows).
                        **Tier 2:**
                          - Neuromuscular blockade, repeat hyperosmolar therapy under strict monitoring.
                        **Tier 3:**
                          - Decompressive craniectomy or other advanced neurosurgical measures.
                        **Monitoring:**
                          - Continuous ICP monitor if available, MAP, CPP (CPP = MAP ‚àí ICP), hourly neuro checks.
                        **Escalation:**
                          - Prompt neurosurgery consult for increasing ICP despite measures.</div>
                </div>
                <div id="protocol-4B" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-4B-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">B. Status Epilepticus Management<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-4B-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**B. Status Epilepticus Management (Adult)**

                        **Indication:**
                          - Seizure activity > 5 minutes or recurrent seizures without recovery.
                        **Checklist:**
                          1. Secure airway, breathing, oxygenation; check glucose and correct hypoglycemia (IV dextrose).
                          2. First-line: IV benzodiazepine (lorazepam 4 mg IV slow; may repeat x1).
                          3. Second-line: load antiepileptic medication e.g., levetiracetam 1‚Äì2 g IV, fosphenytoin 20 mg PE/kg, or valproate 20‚Äì40 mg/kg IV (choose per contraindications).
                          4. If refractory: initiate anesthetic infusion (midazolam/propofol/thiopental), intubate for airway protection, and arrange continuous EEG monitoring.
                        **Monitoring:**
                          - Continuous EEG if available, vital signs, ABG, electrolytes.</div>
                </div>
                <div id="protocol-4C" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-4C-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">C. Acute Ischemic Stroke ‚Äî Thrombolysis Checklist (IV tPA)<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-4C-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**C. Acute Ischemic Stroke ‚Äî Thrombolysis Checklist (IV tPA)**

                        **Indication:**
                          - Acute ischemic stroke within time window and no contraindications.
                        **Checklist:**
                          1. Rapid neurological assessment and NIHSS score.
                          2. Non-contrast CT brain to exclude hemorrhage.
                          3. If eligible, administer IV alteplase per weight-based dosing (verify exact dose in drug lookup).
                          4. Post-thrombolysis monitoring in ICU/stroke unit: frequent neuro checks and BP control per protocol.
                        **Notes:**
                          - Follow AHA/ASA guidelines and local stroke pathway.</div>
                </div>
                <div id="protocol-4D" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-4D-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">D. Intracerebral Hemorrhage (ICH) Emergency Management<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-4D-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**D. Intracerebral Hemorrhage (ICH) Emergency Management**

                        **Indication:**
                          - ICH on imaging with neurological deterioration or large hematoma.
                        **Checklist:**
                          1. ABCs and stabilization; reverse anticoagulation if present (vitamin K, PCC/FFP for warfarin; specific antidotes for DOACs if available).
                          2. Control blood pressure per neuro/ICH protocol (avoid rapid BP swings).
                          3. Neurosurgery consult for possible surgical evacuation; monitor ICP and consider ICP-targeted therapy.</div>
                </div>
                <div id="protocol-4E" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-4E-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">E. Brain Death Determination Checklist<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-4E-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**E. Brain Death Determination Checklist**

                        **Indication:**
                          - Suspected brain death after catastrophic neurologic injury.
                        **Checklist:**
                          - Follow institutional and national legal criteria (prerequisites: comatose state, no confounding factors,
                            normothermia, normotension), perform brainstem reflex assessment and apnea test per protocol,
                            and document thoroughly. Involve neurology/neurosurgery and legal as required.</div>
                </div>
            </div>
            
            <!-- Protocol Category 5: Respiratory Emergencies (NEW) -->
            <div id="protocol-category-5" onclick="toggleProtocolCategory('5')" class="protocol-category">
                5) Respiratory Emergencies <span class="float-right text-lg arrow-5">‚Üí</span>
            </div>
            <div id="protocol-items-5" class="protocol-category-items border border-gray-700 p-3 rounded-lg mb-4 hidden space-y-2" style="background-color: #121212;">
                 <!-- Protocols 5A - 5D content goes here -->
                <div id="protocol-5A" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-5A-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">A. Acute Severe Asthma (Status Asthmaticus)<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-5A-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**A. Acute Severe Asthma (Status Asthmaticus)**
                        
                        **Indication:**
                          - Severe bronchospasm refractory to initial treatment; respiratory fatigue; life-threatening features.
                        **Checklist:**
                          1. High-flow oxygen to maintain target SpO‚ÇÇ.
                          2. Continuous nebulized short-acting beta-agonist (salbutamol), consider ipratropium.
                          3. Systemic corticosteroids (IV methylprednisolone or equivalent).
                          4. Consider IV magnesium sulfate (2 g over 20 min) for severe cases.
                          5. Trial NIV in selected patients; if signs of fatigue, rising PaCO‚ÇÇ, or altered consciousness ‚Äî intubate early.
                        **Monitoring:**
                          - ABG, electrolyte monitoring (K+), continuous SpO‚ÇÇ.</div>
                </div>
                <div id="protocol-5B" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-5B-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">B. Acute COPD Exacerbation Management<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-5B-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**B. Acute COPD Exacerbation Management**

                        **Checklist:**
                          1. Oxygen titrated to SpO‚ÇÇ 88‚Äì92%.
                          2. Nebulized bronchodilators (short-acting beta-agonist & anticholinergic).
                          3. Systemic corticosteroids (e.g., IV methylprednisolone/dose per local protocol).
                          4. NIV for hypercapnic respiratory failure; intubate if NIV fails or patient deteriorates.
                          5. Consider antibiotics if infection suspected.</div>
                </div>
                <div id="protocol-5C" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-5C-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">C. Pulmonary Embolism (PE) ‚Äî Acute Management<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-5C-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**C. Pulmonary Embolism (PE) ‚Äî Acute Management**

                        **Indication:**
                          - Suspected/confirmed PE with hemodynamic instability or RV strain.
                        **Checklist:**
                          - Hemodynamically unstable patients: consider systemic thrombolysis if no contraindications and consult relevant specialists.
                          - Hemodynamically stable: start anticoagulation (LMWH/UFH) unless contraindicated; imaging (CTPA) where feasible.
                          - For large burden / RV dysfunction: consider catheter-directed therapy or surgical embolectomy with specialist teams.</div>
                </div>
                <div id="protocol-5D" class="rounded-lg overflow-hidden"><div onclick="toggleProtocol('protocol-5D-content')" class="protocol-item p-3 flex justify-between items-center font-semibold text-teal-400 text-sm">D. Tension Pneumothorax & Pneumothorax Management<span class="text-lg text-teal-500">‚ñº</span></div><div id="protocol-5D-content" class="protocol-content p-4 text-xs whitespace-pre-wrap" style="background-color: #252525;">**D. Tension Pneumothorax & Pneumothorax Management**

                        **Indication:**
                          - Sudden respiratory distress, hypoxia, hypotension, unilateral absent breath sounds, possible tracheal deviation.
                        **Checklist:**
                          1. Immediate decompression: needle decompression (2nd ICS mid-clavicular or 5th ICS mid-axillary per local policy) for tension physiology.
                          2. Follow with chest tube insertion (tube thoracostomy) using sterile technique and confirm position with CXR.
                          3. For small, asymptomatic primary pneumothorax: observation and supplemental O‚ÇÇ may suffice depending on size.</div>
                </div>
            </div>

        </div>
    </div>


    <!-- Promotional Footer -->
    <footer class="mt-8 pt-6 border-t border-gray-700 card-panel p-6">
        <h3 class="text-lg font-bold text-white mb-4">üìö Learn Critical Care with Dr. XzeCure</h3>
        
        <div class="flex flex-col md:flex-row md:space-x-8 space-y-6 md:space-y-0 text-sm">
            
            <!-- Courses and Social -->
            <div class="md:w-1/3">
                <h4 class="font-semibold text-teal-500 mb-2 border-b border-gray-700 pb-1">Courses & Social Media</h4>
                <p class="mb-2"><a href="https://wa.link/ex9dxa" target="_blank" class="text-green-500 font-bold hover:underline">Enroll for ICU course, Starting 20/10/25</a></p>
                <p class="mb-2">Follow for more: <a href="https://www.instagram.com/askdr.xze" target="_blank" class="text-pink-400 hover:underline font-medium">IG: @askdr.xze</a></p>
                <p class="mb-2">
                    <a href="https://linktr.ee/xzecure" target="_blank" class="btn btn-secondary text-xs">
                        Link Tree
                    </a>
                </p>
            </div>

            <!-- Books & E-books -->
            <div class="md:w-2/3 grid grid-cols-1 sm:grid-cols-3 gap-6">
                
                <!-- Book 1 -->
                <div>
                    <h4 class="font-semibold text-teal-500 mb-2 border-b border-gray-700 pb-1">üìò 1. ICU ESSENTIALS</h4>
                    <ul class="space-y-1 text-muted">
                        <li>Paperback: <a href="https://store.pothi.com/book/dr-kenil-shah-icu-essentials-50-common-case-presentations/" target="_blank" class="text-blue-400 hover:underline">Pothi Store</a></li>
                        <li>Audio: <a href="https://play.google.com/store/audiobooks/details?id=AQAAAEAqIFhgYM" target="_blank" class="text-orange-400 hover:underline">Google Audiobooks</a></li>
                        <li>E-book: <a href="https://amzn.in/d/95JsyRX" target="_blank" class="text-blue-400 hover:underline">Amazon</a> | <a href="https://play.google.com/store/books/details?id=FldpEQAAQBAJ" target="_blank" class="text-blue-400 hover:underline">Google Books</a></li>
                    </ul>
                </div>

                <!-- Book 2 -->
                <div>
                    <h4 class="font-semibold text-teal-500 mb-2 border-b border-gray-700 pb-1">üìï 2. Ultimate Interpretation Handbook</h4>
                    <ul class="space-y-1 text-muted">
                        <li>Pothi: <a href="https://store.pothi.com/book/ebook-dr-kenil-shah-ultimate-interpretation-handbook/" target="_blank" class="text-blue-400 hover:underline">Pothi Store</a></li>
                        <li>E-book: <a href="https://kdp.amazon.com/amazon-dp-action/in/dualbookshelf.marketplacelink/B0FG51YQ52" target="_blank" class="text-blue-400 hover:underline">Amazon</a> | <a href="https://play.google.com/store/books/details?id=7mpsEQAAQBAJ" target="_blank" class="text-blue-400 hover:underline">Google Books</a></li>
                    </ul>
                </div>

                <!-- Book 3 -->
                <div>
                    <h4 class="font-semibold text-teal-500 mb-2 border-b border-gray-700 pb-1">üìó 3. Say It Simple</h4>
                    <ul class="space-y-1 text-muted">
                        <li>Pothi: <a href="https://store.pothi.com/book/ebook-dr-kenil-shah-ultimate-interpretation-handbook/" target="_blank" class="text-blue-400 hover:underline">Pothi Store</a></li>
                        <li>E-book: <a href="https://kdp.amazon.com/amazon-dp-action/in/dualbookshelf.marketplacelink/B0FFMSJZP2" target="_blank" class="text-blue-400 hover:underline">Amazon</a> | <a href="https://play.google.com/store/books/details?id=unRpEQAAQBAJ" target="_blank" class="text-blue-400 hover:underline">Google Books</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <p class="text-center text-xs text-gray-500 mt-6" style="color: var(--text-muted);">Copyright XzeCure 2025</p>
    </footer>

    
    <script>
        // Global Constants
        const ALGORITHM_VERSION = '3.2.0-FullICU'; 
        const NORMAL_AG = 12;
        const NORMAL_HCO3 = 24;
        const NORMAL_PCO2 = 40;
        const NORMAL_ALBUMIN_GDL = 4.0;
        const PH_WATER = 47; 
        const RESPIRATORY_QUOTIENT = 0.8; 

        // Define strict normal ranges for primary interpretation
        const REF_PH_MIN = 7.35;
        const REF_PH_MAX = 7.45;
        const REF_PCO2_MIN = 35;
        const REF_PCO2_MAX = 45;
        const REF_HCO3_MIN = 22;
        const REF_HCO3_MAX = 28;

        // --- Utility Functions ---

        /** Returns an ISO 8601 timestamp string. */
        function now_iso() {
            return moment().toISOString();
        }

        // --- View Toggling Functions (for the single-page experience) ---
        function showProtocolsPage() {
            document.getElementById('abg-view').classList.add('hidden');
            document.getElementById('protocol-view').classList.remove('hidden');
        }

        function showCalculatorPage() {
            document.getElementById('protocol-view').classList.add('hidden');
            document.getElementById('abg-view').classList.remove('hidden');
        }

        function toggleProtocolCategory(categoryId) {
            const content = document.getElementById(`protocol-items-${categoryId}`);
            const arrow = document.querySelector(`.arrow-${categoryId}`);
            const isContentVisible = !content.classList.contains('hidden');

            // Hide all protocol items and reset arrows
            document.querySelectorAll('.protocol-category-items').forEach(item => {
                item.classList.add('hidden');
            });
            document.querySelectorAll('.protocol-category .float-right').forEach(arr => {
                arr.innerHTML = '‚Üí';
            });
            document.querySelectorAll('.protocol-content').forEach(subContent => {
                subContent.classList.remove('active');
            });


            if (!isContentVisible) {
                // Show the clicked content
                content.classList.remove('hidden');
                arrow.innerHTML = '‚Üì'; // Down arrow
            }
        }
        
        function toggleProtocol(contentId) {
            const content = document.getElementById(contentId);
            const isContentOpen = content.classList.contains('active');

            // Close all other open sub-protocols globally to ensure clean view
            document.querySelectorAll('.protocol-content').forEach(c => {
                if (c.id !== contentId) {
                    c.classList.remove('active');
                }
            });
            
            // Toggle the clicked content
            if (!isContentOpen) {
                content.classList.add('active');
            } else {
                content.classList.remove('active');
            }
        }

        // --- ABG Calculation Functions (Core logic) ---

        function parseABGInputs() {
            const getVal = (id) => {
                const el = document.getElementById(id);
                const val = parseFloat(el.value);
                return isNaN(val) ? null : val;
            };

            const inputs = {
                pH: getVal('input_pH'), paco2: getVal('input_paco2'), hco3: getVal('input_hco3'),
                pao2: getVal('input_pao2'), fio2: getVal('input_fio2'), na: getVal('input_na'),
                k: getVal('input_k'), cl: getVal('input_cl'), albumin: getVal('input_albumin'),
                lactate: getVal('input_lactate'), age: getVal('input_age'), pb: 760,
            };

            if (inputs.pH === null || inputs.paco2 === null || inputs.hco3 === null) {
                return { error: "pH, PaCO‚ÇÇ, and HCO‚ÇÉ‚Åª are required inputs." };
            }
            if (inputs.pH < 6.8 || inputs.pH > 8.0) {
                return { error: `pH value (${inputs.pH}) is physiologically implausible.` };
            }
            if (inputs.paco2 < 5 || inputs.paco2 > 200) {
                return { error: `PaCO‚ÇÇ value (${inputs.paco2}) is physiologically implausible.` };
            }
            return inputs;
        }

        function interpretABGAlgorithm(input) {
            const { pH, paco2, hco3, pao2, fio2, na, cl, albumin, lactate, age, pb } = input;
            const calc_log = [];
            let mixed = false;
            let compensation = {};
            let ag = null;
            let corrected_ag = null;
            let delta_ratio = null;
            let a_a = null;
            let pf = null;

            // 1. Determine Normal Status
            const isNormal = (pH >= REF_PH_MIN && pH <= REF_PH_MAX) &&
                             (paco2 >= REF_PCO2_MIN && paco2 <= REF_PCO2_MAX) &&
                             (hco3 >= REF_HCO3_MIN && hco3 <= REF_HCO3_MAX);

            if (isNormal) {
                return {
                    primary_diagnoses: [{ label: "Normal Acid-Base Status", confidence: 1.0, rationale: "All primary ABG parameters are within strict reference ranges." }],
                    mixed_disorder_detected: false,
                    anion_gap: { value: null, corrected: null },
                    delta_ratio: null, a_a_gradient: null, pf_ratio: null,
                    calculation_log: ["1. All primary ABG values (pH, PaCO2, HCO3) are within the normal reference range."],
                    confidence_score: 1.0,
                    timestamp: now_iso(),
                };
            }


            // 2. Continue full interpretation if not perfectly normal
            let acid_base_state = "near-normal";
            if (pH < REF_PH_MIN) acid_base_state = "acidosis";
            else if (pH > REF_PH_MAX) acid_base_state = "alkalosis";
            calc_log.push(`1. pH -> ${pH.toFixed(2)} => ${acid_base_state}`);

            const paCO2_dir = paco2 > REF_PCO2_MAX ? "high" : (paco2 < REF_PCO2_MIN ? "low" : "normal");
            const HCO3_dir = hco3 > REF_HCO3_MAX ? "high" : (hco3 < REF_HCO3_MIN ? "low" : "normal");
            calc_log.push(`2. PaCO2 ${paco2} (${paCO2_dir}), HCO3 ${hco3} (${HCO3_dir})`);

            let primary_candidates = [];
            if (acid_base_state === "acidosis") {
                if (paCO2_dir === "high") primary_candidates.push("Respiratory Acidosis");
                if (HCO3_dir === "low") primary_candidates.push("Metabolic Acidosis");
            } else if (acid_base_state === "alkalosis") {
                if (paCO2_dir === "low") primary_candidates.push("Respiratory Alkalosis");
                if (HCO3_dir === "high") primary_candidates.push("Metabolic Alkalosis");
            }
            
            let ag_check_value = null;
            if (na !== null && cl !== null) {
                ag = na - (cl + hco3);
                ag_check_value = ag;
                calc_log.push(`3. Anion Gap (AG): ${ag.toFixed(1)}`);

                if (albumin !== null) {
                    const ag_correction = 2.5 * (NORMAL_ALBUMIN_GDL - albumin);
                    corrected_ag = ag + ag_correction;
                    ag_check_value = corrected_ag;
                    calc_log.push(`   Albumin Correction: ${ag_correction.toFixed(1)}`);
                    calc_log.push(`   Corrected AG: ${corrected_ag.toFixed(1)}`);
                }

                if (ag_check_value > NORMAL_AG + 2) { 
                    if (primary_candidates.includes("Metabolic Acidosis") === false && HCO3_dir === "low") {
                        primary_candidates.push("High AG Metabolic Acidosis"); 
                    } else if (primary_candidates.includes("Metabolic Acidosis")) {
                        primary_candidates[primary_candidates.indexOf("Metabolic Acidosis")] = "High AG Metabolic Acidosis";
                    }
                    
                    const deltaAG = ag_check_value - NORMAL_AG;
                    const deltaHCO3 = NORMAL_HCO3 - hco3;
                    
                    if (deltaHCO3 !== 0) {
                        delta_ratio = parseFloat((deltaAG / deltaHCO3).toFixed(2));
                        calc_log.push(`   Delta Ratio (ŒîAG/ŒîHCO3): ${delta_ratio}`);
                    }
                }
            }

            const tolerance = 2.0;
            if (primary_candidates.some(c => c.includes("Metabolic Acidosis"))) {
                const expected_paco2_min = (1.5 * hco3 + 8) - tolerance;
                const expected_paco2_max = (1.5 * hco3 + 8) + tolerance;
                let status;
                if (paco2 >= expected_paco2_min && paco2 <= expected_paco2_max) status = "appropriate";
                else if (paco2 > expected_paco2_max) { status = "inappropriate - concurrent Resp Acidosis"; mixed = true; }
                else { status = "inappropriate - concurrent Resp Alkalosis"; mixed = true; }
                compensation.metabolic_acidosis_winter = { expected_paco2_range: `${expected_paco2_min.toFixed(1)} - ${expected_paco2_max.toFixed(1)}`, observed_vs_expected: status };
                calc_log.push(`4. Compensation Check (Met Acidosis): PaCO2 expected ${compensation.metabolic_acidosis_winter.expected_paco2_range} -> ${status}`);
            }
            
            if (primary_candidates.includes("Respiratory Acidosis")) {
                const delta_pco2 = paco2 - NORMAL_PCO2;
                const expected_hco3_acute = NORMAL_HCO3 + (1 * (delta_pco2 / 10));
                const expected_hco3_chronic = NORMAL_HCO3 + (3.5 * (delta_pco2 / 10));
                let status;
                const diff_acute = Math.abs(hco3 - expected_hco3_acute);
                const diff_chronic = Math.abs(hco3 - expected_hco3_chronic);
                if (diff_acute < 3) status = "appropriate - acute";
                else if (diff_chronic < 3) status = "appropriate - chronic";
                else { status = "inappropriate - consider mixed"; mixed = true; }
                compensation.respiratory_acidosis = { expected_hco3_acute: parseFloat(expected_hco3_acute.toFixed(1)), expected_hco3_chronic: parseFloat(expected_hco3_chronic.toFixed(1)), observed_vs_expected: status };
                calc_log.push(`4. Compensation Check (Resp Acidosis): HCO3 acute expected ${compensation.respiratory_acidosis.expected_hco3_acute}, chronic ${compensation.respiratory_acidosis.expected_hco3_chronic} -> ${status}`);
            }

            if (acid_base_state === "near-normal" && primary_candidates.length === 0) {
                if (paco2_dir === "high" && HCO3_dir === "high") {
                    primary_candidates.push("Chronic Respiratory Acidosis (Fully Compensated)");
                } else if (paco2_dir === "low" && HCO3_dir === "low") {
                    primary_candidates.push("Chronic Respiratory Alkalosis (Fully Compensated)");
                } else if (paCO2_dir !== "normal" || HCO3_dir !== "normal") {
                    primary_candidates.push("Fully Compensated Disorder (Requires context)");
                } else {
                    primary_candidates.push("Normal Acid-Base Status (Minimal Derangement)"); 
                }
            } else if (primary_candidates.length === 0) {
                 primary_candidates.push("Indeterminate Primary Disturbance");
            }

            let aa_interpret = null;
            let pf_interpret = null;
            let normal_Aa = null;

            if (pao2 !== null && fio2 !== null && fio2 >= 0.21 && fio2 <= 1.0) {
                const PAO2 = fio2 * (pb - PH_WATER) - (paco2 / RESPIRATORY_QUOTIENT);
                const A_a_value = PAO2 - pao2;
                a_a = { value: parseFloat(A_a_value.toFixed(1)) };
                
                normal_Aa = age !== null ? (age / 4.0) + 4.0 : 10.0;
                a_a.normal_for_age = parseFloat(normal_Aa.toFixed(1));

                if (A_a_value <= normal_Aa) { aa_interpret = "A-a gradient is normal (Hypoventilation or normal gas exchange)."; } 
                else { aa_interpret = "A-a gradient is elevated (V/Q mismatch or shunt likely)."; }
                a_a.interpretation = aa_interpret;
                calc_log.push(`5. A-a Gradient: ${a_a.value} (Normal < ${a_a.normal_for_age}) -> ${aa_interpret}`);


                const PF_VALUE = pao2 / fio2;
                pf = { value: parseFloat(PF_VALUE.toFixed(1)) };
                
                if (PF_VALUE < 100) pf_interpret = "Severe hypoxemia (ARDS criteria severe)";
                else if (PF_VALUE < 200) pf_interpret = "Moderate hypoxemia (ARDS criteria moderate)";
                else if (PF_VALUE < 300) pf_interpret = "Mild hypoxemia (ARDS criteria mild)";
                else pf_interpret = "Normal oxygenation";
                pf.interpretation = pf_interpret;
                calc_log.push(`   P/F Ratio: ${pf.value} -> ${pf_interpret}`);
            }
            
            let max_confidence = 0.6;
            const final_diagnosis_list = primary_candidates.map(cand => {
                const ph_dev = Math.abs(7.4 - pH);
                let conf = Math.min(0.95, 0.4 + ph_dev * 0.8);
                max_confidence = Math.max(max_confidence, conf);
                return { label: cand, confidence: parseFloat(conf.toFixed(2)), rationale: `pH ${acid_base_state}, PaCO2 ${paCO2_dir}, HCO3 ${HCO3_dir}.` };
            });

            if (mixed) {
                final_diagnosis_list.push({ label: 'Mixed Acid-Base Disorder Confirmed', confidence: 0.85, rationale: 'Compensation limits exceeded or conflicting primary changes detected.' });
            }

            const confidence = Math.max(0.1, Math.min(0.99, max_confidence));

            return {
                primary_diagnoses: final_diagnosis_list,
                mixed_disorder_detected: mixed,
                compensation_status: compensation,
                anion_gap: { value: ag, corrected: corrected_ag },
                delta_ratio: delta_ratio,
                a_a_gradient: a_a,
                pf_ratio: pf,
                calculation_log: calc_log,
                confidence_score: parseFloat(confidence.toFixed(2)),
                timestamp: now_iso(),
            };
        }

        async function interpretABG() {
            document.getElementById('abg-loading').classList.remove('hidden');
            document.getElementById('abg-output').classList.add('hidden');
            document.getElementById('abg-error').classList.add('hidden');
            document.getElementById('toggle-log').classList.add('hidden');
            document.getElementById('calculation-log').classList.add('hidden');

            const inputs = parseABGInputs();
            if (inputs.error) {
                document.getElementById('abg-error').innerText = inputs.error;
                document.getElementById('abg-error').classList.remove('hidden');
                document.getElementById('abg-loading').classList.add('hidden');
                return;
            }

            try {
                const result = interpretABGAlgorithm(inputs);
                const summaryDiv = document.getElementById('result-summary');
                const primaryDiag = result.primary_diagnoses[0];

                let isNormal = primaryDiag.label.includes('Normal Acid-Base Status');
                let backgroundClass = isNormal ? 'border-success' : 
                                      (result.mixed_disorder_detected || inputs.pH < REF_PH_MIN || inputs.pH > REF_PH_MAX ? 'border-error' : 'border-accent-blue');
                let headerColor = isNormal ? 'var(--color-success)' : 'var(--text-white)';

                let html = `
                    <div class="space-y-4">
                        <div class="p-4 rounded-md border-2" style="background-color: var(--border-dark); border-color: ${isNormal ? 'var(--color-success)' : 'var(--accent-teal)'};">
                            <h3 class="font-bold text-xl" style="color: ${headerColor}">
                                Primary Finding: <span class="font-extrabold">${primaryDiag.label}</span>
                                <span class="text-sm font-normal" style="color: var(--text-muted);">(Conf: ${result.confidence_score})</span>
                            </h3>
                            ${result.primary_diagnoses.slice(1).map(d => `<p class="text-sm italic ml-1" style="color: var(--color-error);">Mixed/Secondary: ${d.label}</p>`).join('')}
                        </div>
                        
                        <h4 class="font-semibold" style="color: var(--text-light);">Key Metrics:</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm p-4 rounded-lg border" style="background-color: #252525; border-color: var(--border-dark);">
                            <div><span style="color: var(--text-muted);">pH / State:</span> <span class="font-bold">${inputs.pH}</span></div>
                            <div><span style="color: var(--text-muted);">PaCO‚ÇÇ:</span> <span class="font-bold">${inputs.paco2} mmHg</span></div>
                            <div><span style="color: var(--text-muted);">HCO‚ÇÉ‚Åª:</span> <span class="font-bold">${inputs.hco3} mmol/L</span></div>
                            <div><span style="color: var(--text-muted);">AG (Corrected):</span> <span class="font-bold">${result.anion_gap.corrected !== null ? result.anion_gap.corrected.toFixed(1) : (result.anion_gap.value !== null ? result.anion_gap.value.toFixed(1) : 'N/A')}</span></div>
                            ${result.delta_ratio ? `<div><span style="color: var(--text-muted);">Delta Ratio:</span> <span class="font-bold" style="color: var(--color-warning);">${result.delta_ratio}</span></div>` : ''}
                            ${result.pf_ratio ? `<div><span style="color: var(--text-muted);">PF Ratio:</span> <span class="font-bold" style="color: ${result.pf_ratio.value < 300 ? 'var(--color-error)' : 'var(--color-success)'};">${result.pf_ratio.value}</span></div>` : ''}
                            ${result.a_a_gradient ? `<div><span style="color: var(--text-muted);">A-a Grad:</span> <span class="font-bold">${result.a_a_gradient.value} mmHg</span></div>` : ''}
                            ${inputs.lactate ? `<div><span style="color: var(--text-muted);">Lactate:</span> <span class="font-bold" style="color: ${inputs.lactate > 4.0 ? 'var(--color-error)' : (inputs.lactate > 2.0 ? 'var(--color-warning)' : 'var(--color-success)')};">${inputs.lactate} mmol/L</span></div>` : ''}
                        </div>
                    </div>
                `;
                
                summaryDiv.innerHTML = html;
                document.getElementById('calculation-log').innerText = result.calculation_log.join('\n');
                document.getElementById('toggle-log').classList.remove('hidden');

            } catch (e) {
                console.error("ABG Interpretation Error:", e);
                document.getElementById('abg-error').innerText = "An unexpected error occurred during calculation. Please check inputs.";
                document.getElementById('abg-error').classList.remove('hidden');
            } finally {
                document.getElementById('abg-loading').classList.add('hidden');
                document.getElementById('abg-output').classList.remove('hidden');
            }
        }

        function toggleCalculationLog() {
            const log = document.getElementById('calculation-log');
            const button = document.getElementById('toggle-log');
            if (log.classList.contains('hidden')) {
                log.classList.remove('hidden');
                button.innerText = 'Hide Calculation Log';
            } else {
                log.classList.add('hidden');
                button.innerText = 'Show Calculation Log';
            }
        }

        // Initial setup on load
        window.onload = function() {
            interpretABG(); 
        };

    </script>
</body>
</html>


